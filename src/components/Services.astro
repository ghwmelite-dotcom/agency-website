---
import { SITE_CONFIG } from '@/config';

// Fetch services from API
let services: any[] = [];

// Only fetch from API during runtime (not during build)
if (import.meta.env.DEV || Astro.request.url.includes('localhost') || Astro.request.url.includes('127.0.0.1')) {
  try {
    const response = await fetch(Astro.url.origin + '/api/admin/services');
    const data = await response.json();
    if (data.success && data.services && data.services.length > 0) {
      services = data.services;
    } else {
      // Fallback to config if API fails or returns empty
      services = SITE_CONFIG.services || [];
    }
  } catch (error) {
    // Fallback to config
    services = SITE_CONFIG.services || [];
  }
} else {
  // Use fallback data during build
  services = SITE_CONFIG.services || [];
}

// Extended Feather icon map
const iconMap: Record<string, string> = {
  // Code & Development
  code: 'M16 18l2 2 4-4M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z',
  terminal: 'M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z',
  cpu: 'M9 3v4m0 4v4m0 4v4M5 3h4m4 0h4m4 0h4M3 9h4m4 0h4m4 0h4M3 15h4m4 0h4m4 0h4M5 21h4m4 0h4m4 0h4',
  // Design
  palette: 'M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01',
  edit: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z',
  pen: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z',
  // Analytics
  chart: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z',
  'trending-up': 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6',
  activity: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z',
  // Communication
  users: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z',
  user: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z',
  message: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z',
  mail: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
  // Technology
  cloud: 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z',
  server: 'M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01',
  database: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4',
  smartphone: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z',
  laptop: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
  // Business
  briefcase: 'M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z',
  target: 'M9 11l3 3L22 4M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z',
  award: 'M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z',
  // Misc
  sparkles: 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z',
  lightbulb: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z',
  heart: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z',
  star: 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z',
  shield: 'M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM10 14l-3-3 1.5-1.5L10 11l4-4 1.5 1.5L10 14z',
  globe: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9',
  search: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z',
  settings: 'M10.325 4.317c.426-1.756 2.924-1.756 3.350 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z',
  // Clock/Time
  clock: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
  // Layers
  layers: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10'
};

// Fallback icon if not found
const getIcon = (iconName: string) => {
  return iconMap[iconName] || iconMap.sparkles; // Default to sparkles if icon not found
};
---

<section id="services" class="section services">
  <div class="container">
    <div class="section-header" data-animate>
      <h2 data-text-reveal class="animated-header title-hero">
        <span class="title-sparkle">✨</span>
        <span class="title-gradient">What We Do Best</span>
        <span class="title-sparkle">✨</span>
        <div class="title-underline"></div>
      </h2>
      <p class="section-description">
        Comprehensive digital solutions tailored to your business needs
      </p>
    </div>

    <div class="services-grid">
      {services.map((service: any, index: number) => (
        <div class="service-card card" data-animate data-tilt data-magnetic style={`--animation-delay: ${index * 100}ms`}>
          <div class="service-glow"></div>
          <div class="service-icon" data-stagger>
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d={getIcon(service.icon)} />
            </svg>
          </div>
          <h3 data-stagger>{service.title}</h3>
          <p data-stagger>{service.description}</p>
          <a href={`/services/${service.title.toLowerCase().replace(/\s/g, '-')}`} class="service-link" data-ripple data-stagger>
            <span>Learn More</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </a>
        </div>
      ))}
    </div>

    <div class="features-section" data-animate>
      <h3 class="title-hero features-title">
        <span class="title-gradient">Why Choose Us?</span>
        <div class="title-underline"></div>
      </h3>
      <div class="features-grid">
        {SITE_CONFIG.features.map((feature) => (
          <div class="feature-item">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span>{feature}</span>
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  .services {
    background: var(--color-bg-alt);
  }

  .section-header {
    text-align: center;
    max-width: 700px;
    margin: 0 auto var(--spacing-3xl);
  }

  .section-header h2 {
    margin-bottom: var(--spacing-md);
    position: relative;
  }

  .animated-header {
    animation: headerFadeIn 1s ease-out forwards;
    opacity: 0;
  }

  @keyframes headerFadeIn {
    from {
      opacity: 0;
      transform: translateY(30px);
      letter-spacing: 0.1em;
    }
    to {
      opacity: 1;
      transform: translateY(0);
      letter-spacing: normal;
    }
  }

  /* Beautiful Animated Title Styles */
  .title-hero {
    position: relative;
    display: inline-block;
    padding-bottom: 1rem;
  }

  .title-gradient {
    background: linear-gradient(135deg, #6366f1 0%, #ec4899 50%, #f59e0b 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 4s ease infinite;
    display: inline-block;
    font-weight: 800;
  }

  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  .title-sparkle {
    display: inline-block;
    animation: sparkleRotate 3s ease-in-out infinite;
    font-size: 1.5rem;
    margin: 0 0.5rem;
  }

  @keyframes sparkleRotate {
    0%, 100% {
      transform: rotate(0deg) scale(1);
      opacity: 1;
    }
    25% {
      transform: rotate(-15deg) scale(1.2);
      opacity: 0.8;
    }
    50% {
      transform: rotate(15deg) scale(0.9);
      opacity: 1;
    }
    75% {
      transform: rotate(-10deg) scale(1.1);
      opacity: 0.9;
    }
  }

  .title-underline {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, #6366f1, #ec4899, #f59e0b, transparent);
    border-radius: 2px;
    animation: underlineExpand 1.5s ease-out forwards 0.5s;
    box-shadow: 0 2px 10px rgba(99, 102, 241, 0.5);
  }

  @keyframes underlineExpand {
    to {
      width: 80%;
    }
  }

  .section-description {
    font-size: 1.25rem;
    color: var(--color-text-muted);
  }

  .services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-3xl);
  }

  .service-card {
    padding: var(--spacing-xl);
    transition: all 0.4s var(--ease-smooth);
    opacity: 0;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .service-card.animate-in {
    opacity: 1;
    animation: fade-in 0.6s ease-out forwards;
    animation-delay: var(--animation-delay, 0ms);
  }

  .service-card:hover {
    transform: translateY(-12px) scale(1.02);
    box-shadow: 0 30px 60px rgba(99, 102, 241, 0.15);
    border-color: var(--color-primary);
  }

  .service-card:hover .service-icon {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
  }

  .service-card:hover .service-glow {
    opacity: 1;
    transform: scale(1.2);
  }

  .service-glow {
    position: absolute;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.2), transparent 70%);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    opacity: 0;
    transition: all 0.6s var(--ease-smooth);
    border-radius: 50%;
    filter: blur(40px);
  }

  .service-icon {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-xl);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--spacing-md);
    color: var(--color-primary);
    transition: all 0.4s var(--ease-spring);
    position: relative;
    z-index: 1;
  }

  .service-icon::before {
    content: '';
    position: absolute;
    inset: -2px;
    background: var(--gradient-primary);
    border-radius: var(--radius-xl);
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: -1;
  }

  .service-card:hover .service-icon::before {
    opacity: 0.2;
  }

  .service-card h3 {
    font-size: 1.5rem;
    margin-bottom: var(--spacing-sm);
  }

  .service-card p {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-md);
    font-size: 1rem;
  }

  .service-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-primary);
    font-weight: 600;
    font-size: 0.95rem;
    transition: gap var(--transition-base);
  }

  .service-link:hover {
    gap: 0.75rem;
  }

  .features-section {
    text-align: center;
    padding: var(--spacing-2xl);
    background: var(--color-surface);
    border-radius: var(--radius-2xl);
    border: 1px solid var(--color-border);
  }

  .features-section h3 {
    font-size: 2rem;
    margin-bottom: var(--spacing-xl);
  }

  .features-title {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-md);
    max-width: 900px;
    margin: 0 auto;
  }

  .feature-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: var(--spacing-sm);
    text-align: left;
  }

  .feature-item svg {
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .feature-item span {
    color: var(--color-text);
    font-size: 0.95rem;
  }

  @media (max-width: 768px) {
    .section-header h2 {
      font-size: 2rem;
    }

    .section-description {
      font-size: 1.1rem;
    }

    .service-card {
      padding: 1.5rem;
    }

    .service-icon {
      width: 56px;
      height: 56px;
    }

    .features-section h3 {
      font-size: 1.5rem;
    }
  }

  @media (max-width: 640px) {
    .services-grid {
      grid-template-columns: 1fr;
    }

    .features-grid {
      grid-template-columns: 1fr;
    }

    .section-header h2 {
      font-size: 1.75rem;
    }

    .service-card {
      padding: 1.25rem;
    }
  }
</style>
