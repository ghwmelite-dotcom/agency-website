---
import '@/styles/design-system.css';
import '@/styles/dark-mode-fixes.css';
import { SITE_CONFIG } from '@/config';
import LoadingScreen from '@/components/LoadingScreen.astro';
import CustomCursor from '@/components/CustomCursor.astro';
import Chatbot from '@/components/Chatbot.astro';
import PWAInstallPrompt from '@/components/PWAInstallPrompt.astro';
import SocialProof from '@/components/SocialProof.astro';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  noLoader?: boolean;
  article?: {
    publishedTime?: string;
    modifiedTime?: string;
    author?: string;
    section?: string;
    tags?: string[];
  };
}

const {
  title = SITE_CONFIG.name,
  description = SITE_CONFIG.description,
  image = '/og-image.jpg',
  noLoader = false,
  article
} = Astro.props;

const pageTitle = title === SITE_CONFIG.name ? title : `${title} | ${SITE_CONFIG.name}`;
const siteUrl = Astro.url.origin;

// Normalize canonical URL - remove trailing slash except for homepage
let canonicalUrl = Astro.url.href;
if (canonicalUrl.endsWith('/') && canonicalUrl !== siteUrl + '/') {
  canonicalUrl = canonicalUrl.slice(0, -1);
}

const imageUrl = new URL(image, Astro.url).href;

// Determine if this is a utility/noindex page
const currentPath = Astro.url.pathname;
const isNoIndex = currentPath.includes('/newsletter/unsubscribe') ||
  currentPath.includes('/newsletter/verify') ||
  currentPath.includes('/offline') ||
  currentPath.includes('/quiz/thank-you') ||
  currentPath.includes('/sitemap-pages') ||
  currentPath.includes('/admin/') ||
  currentPath.includes('/client/') ||
  currentPath.includes('/api/');
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" id="favicon-link" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />
    <meta name="description" content={description} />
    <meta name="author" content="WP Studios" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? "article" : "website"} />
    <meta property="og:site_name" content="WP Studios" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={imageUrl} />
    <meta property="og:image:secure_url" content={imageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={pageTitle} />
    <meta property="og:locale" content="en_US" />

    {article && (
      <>
        <meta property="article:published_time" content={article.publishedTime} />
        {article.modifiedTime && <meta property="article:modified_time" content={article.modifiedTime} />}
        {article.author && <meta property="article:author" content={article.author} />}
        {article.section && <meta property="article:section" content={article.section} />}
        {article.tags && article.tags.map((tag) => (
          <meta property="article:tag" content={tag} />
        ))}
      </>
    )}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@ohwpstudios" />
    {article?.author && <meta name="twitter:creator" content={`@${article.author.toLowerCase().replace(/\s+/g, '')}`} />}
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={imageUrl} />
    <meta name="twitter:image:alt" content={pageTitle} />

    <!-- Fonts - Optimized with font-display:swap and preload -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" /></noscript>

    <!-- Critical Resource Hints -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />

    <!-- Performance & SEO -->
    <meta name="theme-color" content="#6366f1" />
    <meta name="msapplication-TileColor" content="#6366f1" />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Meta Robots - Prevent indexing of utility pages -->
    {isNoIndex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Structured Data (JSON-LD) for rich search results -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "OHWP Studios",
      "alternateName": "WP Studios",
      "url": siteUrl,
      "logo": `${siteUrl}/icons/icon-512x512.png`,
      "description": SITE_CONFIG.description,
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "US"
      },
      "sameAs": [
        "https://twitter.com/ohwpstudios",
        "https://www.linkedin.com/company/ohwpstudios",
        "https://github.com/ohwpstudios"
      ],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "customer service",
        "url": `${siteUrl}/contact`
      }
    })} />

    {currentPath === '/' && (
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "OHWP Studios",
        "url": siteUrl,
        "potentialAction": {
          "@type": "SearchAction",
          "target": `${siteUrl}/search?q={search_term_string}`,
          "query-input": "required name=search_term_string"
        }
      })} />
    )}

    {article && (
      <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": title,
        "description": description,
        "image": imageUrl,
        "datePublished": article.publishedTime,
        "dateModified": article.modifiedTime || article.publishedTime,
        "author": {
          "@type": "Person",
          "name": article.author || "OHWP Studios"
        },
        "publisher": {
          "@type": "Organization",
          "name": "OHWP Studios",
          "logo": {
            "@type": "ImageObject",
            "url": `${siteUrl}/icons/icon-512x512.png`
          }
        }
      })} />
    )}

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png" />
    <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png" />

    <!-- Apple Web App -->
    <meta name="apple-mobile-web-app-title" content="WP Studios" />

    <!-- Microsoft Tiles -->
    <meta name="msapplication-config" content="/browserconfig.xml" />

    <!-- CRITICAL: Prevent flash of unstyled content (must be inline) -->
    <script is:inline>
      document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
    </script>

    <!-- NON-CRITICAL: Consolidated page initialization (deferred) -->
    <script>
      // Consolidated initialization with sessionStorage caching
      // Reduces 4 API calls to 1, cached for session duration
      async function loadPageData() {
        try {
          // Check if data is already cached in this session
          const cached = sessionStorage.getItem('page-init-data');
          let data;

          if (cached) {
            data = JSON.parse(cached);
          } else {
            // Fetch consolidated data from single endpoint
            const response = await fetch('/api/page-init');
            const result = await response.json();

            if (result.success && result.data) {
              data = result.data;
              // Cache for session
              sessionStorage.setItem('page-init-data', JSON.stringify(data));
            }
          }

          if (!data) return;

          // Apply theme customization
          if (data.theme) {
            const settings = data.theme;
            const root = document.documentElement;

            // Helper to darken/lighten colors
            function shadeColor(color, percent) {
              const num = parseInt(color.replace("#",""), 16);
              const amt = Math.round(2.55 * percent);
              const R = (num >> 16) + amt;
              const G = (num >> 8 & 0x00FF) + amt;
              const B = (num & 0x0000FF) + amt;
              return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
            }

            // Apply custom colors
            if (settings.color_primary) {
              root.style.setProperty('--color-primary', settings.color_primary);
              root.style.setProperty('--color-primary-dark', shadeColor(settings.color_primary, -20));
              root.style.setProperty('--color-primary-light', shadeColor(settings.color_primary, 20));
            }
            if (settings.color_secondary) {
              root.style.setProperty('--color-secondary', settings.color_secondary);
            }
            if (settings.color_accent) {
              root.style.setProperty('--color-accent', settings.color_accent);
            }
            if (settings.color_wordpress) {
              root.style.setProperty('--color-wordpress', settings.color_wordpress);
              root.style.setProperty('--color-wordpress-dark', shadeColor(settings.color_wordpress, -20));
              root.style.setProperty('--color-wordpress-light', shadeColor(settings.color_wordpress, 20));
            }

            // Update gradients
            if (settings.color_primary && settings.color_secondary) {
              root.style.setProperty('--gradient-primary', `linear-gradient(135deg, ${settings.color_primary} 0%, ${settings.color_secondary} 100%)`);
            }
            if (settings.color_wordpress) {
              root.style.setProperty('--gradient-wordpress', `linear-gradient(135deg, ${settings.color_wordpress} 0%, ${shadeColor(settings.color_wordpress, 20)} 100%)`);
            }

            // Load Google Fonts
            if (settings.font_heading || settings.font_body) {
              const fontsToLoad = new Set();
              if (settings.font_heading) fontsToLoad.add(settings.font_heading);
              if (settings.font_body) fontsToLoad.add(settings.font_body);

              const fontFamilies = Array.from(fontsToLoad).map(f => `family=${String(f).replace(/ /g, '+')}:wght@300;400;500;600;700;800`).join('&');
              const link = document.createElement('link');
              link.href = `https://fonts.googleapis.com/css2?${fontFamilies}&display=swap`;
              link.rel = 'stylesheet';
              document.head.appendChild(link);

              // Apply font families
              if (settings.font_heading) {
                root.style.setProperty('--font-display', `'${settings.font_heading}', ${root.style.getPropertyValue('--font-display') || 'sans-serif'}`);
              }
              if (settings.font_body) {
                root.style.setProperty('--font-sans', `'${settings.font_body}', ${root.style.getPropertyValue('--font-sans') || 'sans-serif'}`);
              }
            }
          }

          // Apply favicon
          if (data.content && data.content.site_favicon) {
            const faviconUrl = data.content.site_favicon.trim();
            if (faviconUrl !== '') {
              const faviconLink = document.getElementById('favicon-link');
              if (faviconLink) {
                faviconLink.href = faviconUrl;

                // Update type based on file extension
                if (faviconUrl.endsWith('.svg')) {
                  faviconLink.type = 'image/svg+xml';
                } else if (faviconUrl.endsWith('.png')) {
                  faviconLink.type = 'image/png';
                } else if (faviconUrl.endsWith('.ico')) {
                  faviconLink.type = 'image/x-icon';
                }
              }
            }
          }

          // Make data globally available for other components
          window.pageInitData = data;

        } catch (error) {
          console.log('Using default theme and content');
        }
      }

      loadPageData();
    </script>
  </head>
  <body>
    {!noLoader && <LoadingScreen />}
    <CustomCursor />
    <slot />
    <Chatbot />
    <SocialProof />
    <PWAInstallPrompt />

    <!-- Consolidated initialization scripts (deferred for performance) -->
    <script src="/scripts/init.js" is:inline defer></script>

    <!-- Optimized Animations System with Lazy Loading (deferred for performance) -->
    <script src="/animations-optimized.js" is:inline defer></script>
  </body>
</html>
