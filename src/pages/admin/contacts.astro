---
import BaseLayout from '@/layouts/BaseLayout.astro';

export const prerender = false;

const title = 'Contact Submissions';
---

<BaseLayout title={title} noLoader={true}>
  <div class="admin-container">
    <div class="admin-header">
      <div class="header-left">
        <a href="/admin/dashboard" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back to Dashboard
        </a>
        <h1>Contact Submissions</h1>
      </div>
      <button id="export-csv" class="btn-export">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export CSV
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Total Submissions</div>
          <div class="stat-value" id="stat-total">-</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">New</div>
          <div class="stat-value" id="stat-new">-</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">In Progress</div>
          <div class="stat-value" id="stat-progress">-</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #ec4899, #be185d);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Converted</div>
          <div class="stat-value" id="stat-converted">-</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filters-row">
        <div class="search-box">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input type="text" id="search-input" placeholder="Search by name, email, company..." />
        </div>

        <select id="status-filter" class="filter-select">
          <option value="">All Statuses</option>
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="in_progress">In Progress</option>
          <option value="converted">Converted</option>
          <option value="closed">Closed</option>
        </select>

        <select id="priority-filter" class="filter-select">
          <option value="">All Priorities</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="urgent">Urgent</option>
        </select>

        <select id="service-filter" class="filter-select">
          <option value="">All Services</option>
          <option value="web-development">Web Development</option>
          <option value="ui-ux-design">UI/UX Design</option>
          <option value="branding">Branding & Identity</option>
          <option value="seo-marketing">SEO & Marketing</option>
          <option value="cloud-solutions">Cloud Solutions</option>
          <option value="premium-support">Premium Support</option>
        </select>

        <button id="clear-filters" class="btn-clear">Clear Filters</button>
      </div>
    </div>

    <!-- Submissions Table -->
    <div class="submissions-container">
      <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Loading submissions...</p>
      </div>

      <div id="empty-state" class="empty-state" style="display: none;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
        <h3>No submissions found</h3>
        <p>Try adjusting your filters or check back later</p>
      </div>

      <div id="submissions-list" class="submissions-list" style="display: none;">
        <!-- Submissions will be populated here -->
      </div>

      <div id="pagination" class="pagination" style="display: none;">
        <button id="prev-page" class="btn-page" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous
        </button>
        <span id="page-info" class="page-info">-</span>
        <button id="next-page" class="btn-page">
          Next
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .admin-container {
    min-height: 100vh;
    background: var(--color-background);
    padding: 2rem;
  }

  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .header-left {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .admin-header h1 {
    font-size: 2rem;
    font-weight: 800;
    color: var(--color-text);
  }

  .btn-export {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .stat-content {
    flex: 1;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--color-text);
  }

  /* Filters */
  .filters-section {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .filters-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-box svg {
    position: absolute;
    left: 1rem;
    color: var(--color-text-secondary);
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-size: 1rem;
    background: var(--color-background);
    color: var(--color-text);
    transition: all 0.3s ease;
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-size: 1rem;
    background: var(--color-background);
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }

  .btn-clear {
    padding: 0.75rem 1.5rem;
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-weight: 600;
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-clear:hover {
    background: var(--color-danger);
    border-color: var(--color-danger);
    color: white;
  }

  /* Submissions Container */
  .submissions-container {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 16px;
    padding: 1.5rem;
    min-height: 400px;
  }

  .loading-state,
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state svg {
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--color-text-secondary);
  }

  /* Submissions List */
  .submissions-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .submission-card {
    background: var(--color-background);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .submission-card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.1);
  }

  .submission-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .submission-info {
    flex: 1;
  }

  .submission-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 0.25rem;
  }

  .submission-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .submission-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .badge {
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-new { background: #10b981; color: white; }
  .badge-contacted { background: #3b82f6; color: white; }
  .badge-in_progress { background: #f59e0b; color: white; }
  .badge-converted { background: #ec4899; color: white; }
  .badge-closed { background: #6b7280; color: white; }

  .badge-low { background: #d1d5db; color: #1f2937; }
  .badge-medium { background: #fbbf24; color: #1f2937; }
  .badge-high { background: #f97316; color: white; }
  .badge-urgent { background: #ef4444; color: white; }

  .submission-content {
    margin-bottom: 1rem;
  }

  .submission-service {
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
  }

  .submission-description {
    color: var(--color-text-secondary);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .submission-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .btn-action {
    padding: 0.5rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-surface);
    color: var(--color-text);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
  }

  .btn-action:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .btn-action.danger:hover {
    border-color: var(--color-danger);
    color: var(--color-danger);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
  }

  .btn-page {
    padding: 0.75rem 1.5rem;
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-weight: 600;
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-page:hover:not(:disabled) {
    background: var(--gradient-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .btn-page:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .page-info {
    font-weight: 600;
    color: var(--color-text);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .admin-container {
      padding: 1rem;
    }

    .admin-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .filters-row {
      flex-direction: column;
    }

    .search-box {
      min-width: 100%;
    }

    .submission-header {
      flex-direction: column;
      gap: 1rem;
    }

    .submission-actions {
      width: 100%;
    }

    .btn-action {
      flex: 1;
      justify-content: center;
    }
  }
</style>

<script>
  let currentPage = 0;
  let currentFilters = {
    status: '',
    priority: '',
    service: '',
    search: ''
  };
  let totalSubmissions = 0;
  const limit = 10;

  async function loadSubmissions() {
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const submissionsList = document.getElementById('submissions-list');
    const pagination = document.getElementById('pagination');

    if (loadingState) loadingState.style.display = 'flex';
    if (emptyState) emptyState.style.display = 'none';
    if (submissionsList) submissionsList.style.display = 'none';
    if (pagination) pagination.style.display = 'none';

    try {
      const params = new URLSearchParams({
        limit: limit.toString(),
        offset: (currentPage * limit).toString(),
        ...currentFilters
      });

      // Remove empty filters
      Array.from(params.keys()).forEach(key => {
        if (!params.get(key)) params.delete(key);
      });

      const response = await fetch(`/api/admin/contacts?${params}`);
      const data = await response.json();

      if (loadingState) loadingState.style.display = 'none';

      if (data.success && data.submissions.length > 0) {
        totalSubmissions = data.total;
        renderSubmissions(data.submissions);
        updatePagination(data.total);
      } else {
        if (emptyState) emptyState.style.display = 'flex';
      }

      // Load stats
      loadStats();
    } catch (error) {
      console.error('Error loading submissions:', error);
      if (loadingState) loadingState.style.display = 'none';
      if (emptyState) emptyState.style.display = 'flex';
    }
  }

  async function loadStats() {
    try {
      const response = await fetch('/api/admin/contacts');
      const data = await response.json();

      if (data.success) {
        const stats = {
          total: data.submissions.length,
          new: data.submissions.filter((s: any) => s.status === 'new').length,
          progress: data.submissions.filter((s: any) => s.status === 'in_progress').length,
          converted: data.submissions.filter((s: any) => s.status === 'converted').length
        };

        document.getElementById('stat-total')!.textContent = stats.total.toString();
        document.getElementById('stat-new')!.textContent = stats.new.toString();
        document.getElementById('stat-progress')!.textContent = stats.progress.toString();
        document.getElementById('stat-converted')!.textContent = stats.converted.toString();
      }
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }

  function renderSubmissions(submissions: any[]) {
    const list = document.getElementById('submissions-list');
    if (!list) return;

    list.innerHTML = submissions.map(submission => `
      <div class="submission-card" data-id="${submission.id}">
        <div class="submission-header">
          <div class="submission-info">
            <div class="submission-name">${submission.full_name}</div>
            <div class="submission-meta">
              <span>${submission.email}</span>
              ${submission.phone ? `<span>${submission.phone}</span>` : ''}
              ${submission.company ? `<span>${submission.company}</span>` : ''}
              <span>${formatDate(submission.created_at)}</span>
            </div>
          </div>
          <div class="submission-badges">
            <span class="badge badge-${submission.status}">${submission.status}</span>
            <span class="badge badge-${submission.priority}">${submission.priority}</span>
          </div>
        </div>
        <div class="submission-content">
          <div class="submission-service">${formatServiceType(submission.service_type)}</div>
          <div class="submission-description">${submission.project_description}</div>
        </div>
        <div class="submission-actions">
          <button class="btn-action" onclick="viewSubmission(${submission.id})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            View Details
          </button>
          <select class="filter-select" onchange="updateStatus(${submission.id}, this.value)">
            <option value="">Update Status</option>
            <option value="new" ${submission.status === 'new' ? 'selected' : ''}>New</option>
            <option value="contacted" ${submission.status === 'contacted' ? 'selected' : ''}>Contacted</option>
            <option value="in_progress" ${submission.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
            <option value="converted" ${submission.status === 'converted' ? 'selected' : ''}>Converted</option>
            <option value="closed" ${submission.status === 'closed' ? 'selected' : ''}>Closed</option>
          </select>
          <button class="btn-action danger" onclick="deleteSubmission(${submission.id})">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
          </button>
        </div>
      </div>
    `).join('');

    list.style.display = 'flex';
  }

  function updatePagination(total: number) {
    const pagination = document.getElementById('pagination');
    const prevBtn = document.getElementById('prev-page') as HTMLButtonElement;
    const nextBtn = document.getElementById('next-page') as HTMLButtonElement;
    const pageInfo = document.getElementById('page-info');

    if (!pagination || !prevBtn || !nextBtn || !pageInfo) return;

    const totalPages = Math.ceil(total / limit);
    const currentPageDisplay = currentPage + 1;

    pageInfo.textContent = `Page ${currentPageDisplay} of ${totalPages}`;

    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = currentPage >= totalPages - 1;

    pagination.style.display = 'flex';
  }

  function formatDate(dateString: string): string {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
  }

  function formatServiceType(service: string): string {
    const map: Record<string, string> = {
      'web-development': 'Web Development',
      'ui-ux-design': 'UI/UX Design',
      'branding': 'Branding & Identity',
      'seo-marketing': 'SEO & Marketing',
      'cloud-solutions': 'Cloud Solutions',
      'premium-support': 'Premium Support'
    };
    return map[service] || service;
  }

  (window as any).viewSubmission = function(id: number) {
    window.location.href = `/admin/contacts/${id}`;
  };

  (window as any).updateStatus = async function(id: number, status: string) {
    if (!status) return;

    try {
      const response = await fetch('/api/admin/contacts', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status })
      });

      const data = await response.json();

      if (data.success) {
        loadSubmissions();
      } else {
        alert('Failed to update status');
      }
    } catch (error) {
      console.error('Error updating status:', error);
      alert('Failed to update status');
    }
  };

  (window as any).deleteSubmission = async function(id: number) {
    if (!confirm('Are you sure you want to delete this submission?')) return;

    try {
      const response = await fetch(`/api/admin/contacts?id=${id}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.success) {
        loadSubmissions();
      } else {
        alert('Failed to delete submission');
      }
    } catch (error) {
      console.error('Error deleting submission:', error);
      alert('Failed to delete submission');
    }
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadSubmissions();

    // Filters
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
    const priorityFilter = document.getElementById('priority-filter') as HTMLSelectElement;
    const serviceFilter = document.getElementById('service-filter') as HTMLSelectElement;
    const clearBtn = document.getElementById('clear-filters');

    searchInput?.addEventListener('input', (e) => {
      currentFilters.search = (e.target as HTMLInputElement).value;
      currentPage = 0;
      loadSubmissions();
    });

    statusFilter?.addEventListener('change', (e) => {
      currentFilters.status = (e.target as HTMLSelectElement).value;
      currentPage = 0;
      loadSubmissions();
    });

    priorityFilter?.addEventListener('change', (e) => {
      currentFilters.priority = (e.target as HTMLSelectElement).value;
      currentPage = 0;
      loadSubmissions();
    });

    serviceFilter?.addEventListener('change', (e) => {
      currentFilters.service = (e.target as HTMLSelectElement).value;
      currentPage = 0;
      loadSubmissions();
    });

    clearBtn?.addEventListener('click', () => {
      currentFilters = { status: '', priority: '', service: '', search: '' };
      currentPage = 0;
      searchInput.value = '';
      statusFilter.value = '';
      priorityFilter.value = '';
      serviceFilter.value = '';
      loadSubmissions();
    });

    // Pagination
    document.getElementById('prev-page')?.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        loadSubmissions();
      }
    });

    document.getElementById('next-page')?.addEventListener('click', () => {
      const totalPages = Math.ceil(totalSubmissions / limit);
      if (currentPage < totalPages - 1) {
        currentPage++;
        loadSubmissions();
      }
    });

    // Export CSV
    document.getElementById('export-csv')?.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/admin/contacts');
        const data = await response.json();

        if (data.success) {
          const csv = convertToCSV(data.submissions);
          downloadCSV(csv, 'contact-submissions.csv');
        }
      } catch (error) {
        console.error('Error exporting CSV:', error);
        alert('Failed to export CSV');
      }
    });
  });

  function convertToCSV(data: any[]): string {
    const headers = ['ID', 'Name', 'Email', 'Phone', 'Company', 'Service', 'Budget', 'Timeline', 'Description', 'Status', 'Priority', 'Created At'];
    const rows = data.map(item => [
      item.id,
      item.full_name,
      item.email,
      item.phone || '',
      item.company || '',
      item.service_type,
      item.budget_range || '',
      item.project_timeline || '',
      item.project_description,
      item.status,
      item.priority,
      item.created_at
    ]);

    return [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');
  }

  function downloadCSV(csv: string, filename: string) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
  }
</script>
</BaseLayout>
