---
import BaseLayout from '@/layouts/BaseLayout.astro';

export const prerender = false;

const { id } = Astro.params;
const title = 'Contact Submission Details';
---

<BaseLayout title={title} noLoader={true}>
  <div class="admin-container">
    <div class="admin-header">
      <div class="header-left">
        <a href="/admin/contacts" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back to Submissions
        </a>
        <h1>Submission Details</h1>
      </div>
    </div>

    <div id="loading-state" class="loading-state">
      <div class="spinner"></div>
      <p>Loading submission...</p>
    </div>

    <div id="content-container" style="display: none;">
      <div class="details-grid">
        <!-- Main Info Card -->
        <div class="detail-card main-card">
          <div class="card-header">
            <h2>Contact Information</h2>
            <div class="status-badges">
              <span id="status-badge" class="badge"></span>
              <span id="priority-badge" class="badge"></span>
            </div>
          </div>

          <div class="info-section">
            <div class="info-row">
              <div class="info-label">Full Name</div>
              <div class="info-value" id="full-name"></div>
            </div>
            <div class="info-row">
              <div class="info-label">Email</div>
              <div class="info-value">
                <a id="email-link" href="" class="email-link"></a>
              </div>
            </div>
            <div class="info-row" id="phone-row" style="display: none;">
              <div class="info-label">Phone</div>
              <div class="info-value" id="phone"></div>
            </div>
            <div class="info-row" id="company-row" style="display: none;">
              <div class="info-label">Company</div>
              <div class="info-value" id="company"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="info-section">
            <h3>Project Details</h3>
            <div class="info-row">
              <div class="info-label">Service Type</div>
              <div class="info-value" id="service-type"></div>
            </div>
            <div class="info-row" id="budget-row" style="display: none;">
              <div class="info-label">Budget Range</div>
              <div class="info-value" id="budget"></div>
            </div>
            <div class="info-row" id="timeline-row" style="display: none;">
              <div class="info-label">Project Timeline</div>
              <div class="info-value" id="timeline"></div>
            </div>
            <div class="info-row">
              <div class="info-label">Project Description</div>
              <div class="info-value description" id="description"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="info-section">
            <h3>Additional Information</h3>
            <div class="info-row" id="how-found-row" style="display: none;">
              <div class="info-label">How Found Us</div>
              <div class="info-value" id="how-found"></div>
            </div>
            <div class="info-row">
              <div class="info-label">Submitted</div>
              <div class="info-value" id="created-at"></div>
            </div>
            <div class="info-row" id="responded-row" style="display: none;">
              <div class="info-label">Responded At</div>
              <div class="info-value" id="responded-at"></div>
            </div>
          </div>
        </div>

        <!-- Management Card -->
        <div class="detail-card">
          <div class="card-header">
            <h2>Manage Submission</h2>
          </div>

          <div class="form-section">
            <div class="form-group">
              <label>Status</label>
              <select id="status-select" class="form-select">
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="in_progress">In Progress</option>
                <option value="converted">Converted</option>
                <option value="closed">Closed</option>
              </select>
            </div>

            <div class="form-group">
              <label>Priority</label>
              <select id="priority-select" class="form-select">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>

            <div class="form-group">
              <label>Assign To</label>
              <input type="text" id="assigned-to" class="form-input" placeholder="Team member name" />
            </div>

            <div class="form-group">
              <label>Internal Notes</label>
              <textarea id="notes" class="form-textarea" rows="6" placeholder="Add internal notes about this submission..."></textarea>
            </div>

            <button id="save-btn" class="btn-save">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Save Changes
            </button>
          </div>

          <div class="divider"></div>

          <div class="quick-actions">
            <h3>Quick Actions</h3>
            <button class="btn-action" id="email-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              Email Client
            </button>
            <button class="btn-action danger" id="delete-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Delete Submission
            </button>
          </div>
        </div>

        <!-- Analytics Card -->
        <div class="detail-card" id="analytics-card" style="display: none;">
          <div class="card-header">
            <h2>Form Analytics</h2>
          </div>

          <div class="analytics-grid">
            <div class="analytics-item">
              <div class="analytics-label">Time Spent</div>
              <div class="analytics-value" id="time-spent"></div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">Steps Reached</div>
              <div class="analytics-value" id="steps-reached"></div>
            </div>
            <div class="analytics-item">
              <div class="analytics-label">Completed</div>
              <div class="analytics-value" id="completed"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="info-section">
            <div class="info-row">
              <div class="info-label">User Agent</div>
              <div class="info-value small" id="user-agent"></div>
            </div>
            <div class="info-row" id="referrer-row" style="display: none;">
              <div class="info-label">Referrer</div>
              <div class="info-value small" id="referrer"></div>
            </div>
            <div class="info-row" id="utm-row" style="display: none;">
              <div class="info-label">UTM Parameters</div>
              <div class="info-value" id="utm-params"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .admin-container {
    min-height: 100vh;
    background: var(--color-background);
    padding: 2rem;
  }

  .admin-header {
    margin-bottom: 2rem;
  }

  .header-left {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .admin-header h1 {
    font-size: 2rem;
    font-weight: 800;
    color: var(--color-text);
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .details-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
  }

  .detail-card {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 16px;
    padding: 2rem;
  }

  .main-card {
    grid-column: 1;
    grid-row: 1 / 3;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .card-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
  }

  .card-header h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 1rem;
  }

  .status-badges {
    display: flex;
    gap: 0.5rem;
  }

  .badge {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-new { background: #10b981; color: white; }
  .badge-contacted { background: #3b82f6; color: white; }
  .badge-in_progress { background: #f59e0b; color: white; }
  .badge-converted { background: #ec4899; color: white; }
  .badge-closed { background: #6b7280; color: white; }

  .badge-low { background: #d1d5db; color: #1f2937; }
  .badge-medium { background: #fbbf24; color: #1f2937; }
  .badge-high { background: #f97316; color: white; }
  .badge-urgent { background: #ef4444; color: white; }

  .info-section {
    margin-bottom: 2rem;
  }

  .info-section:last-child {
    margin-bottom: 0;
  }

  .info-row {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  .info-value {
    color: var(--color-text);
    font-weight: 500;
  }

  .info-value.description {
    line-height: 1.6;
    white-space: pre-wrap;
  }

  .info-value.small {
    font-size: 0.875rem;
    word-break: break-all;
  }

  .email-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
  }

  .email-link:hover {
    color: var(--color-secondary);
  }

  .divider {
    height: 2px;
    background: var(--color-border);
    margin: 2rem 0;
  }

  /* Form Section */
  .form-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text);
    font-size: 0.9375rem;
  }

  .form-select,
  .form-input,
  .form-textarea {
    padding: 0.75rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-size: 1rem;
    background: var(--color-background);
    color: var(--color-text);
    transition: all 0.3s ease;
    font-family: var(--font-sans);
  }

  .form-select:focus,
  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }

  .form-textarea {
    resize: vertical;
  }

  .btn-save {
    padding: 1rem 2rem;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
  }

  /* Quick Actions */
  .quick-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .quick-actions h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text);
  }

  .btn-action {
    padding: 1rem 1.5rem;
    background: var(--color-background);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-weight: 600;
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1rem;
  }

  .btn-action:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    transform: translateY(-2px);
  }

  .btn-action.danger {
    color: var(--color-danger);
    border-color: var(--color-border);
  }

  .btn-action.danger:hover {
    border-color: var(--color-danger);
    background: var(--color-danger);
    color: white;
  }

  /* Analytics */
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .analytics-item {
    text-align: center;
    padding: 1rem;
    background: var(--color-background);
    border-radius: 12px;
    border: 2px solid var(--color-border);
  }

  .analytics-label {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
  }

  .analytics-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--color-text);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .details-grid {
      grid-template-columns: 1fr;
    }

    .main-card {
      grid-column: 1;
      grid-row: auto;
    }

    .analytics-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .admin-container {
      padding: 1rem;
    }

    .info-row {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }
  }
</style>

<script define:vars={{ submissionId: id }}>
  let currentSubmission = null;

  async function loadSubmission() {
    try {
      const response = await fetch(`/api/admin/contacts/${submissionId}`);
      const data = await response.json();

      if (data.success) {
        currentSubmission = data.submission;
        renderSubmission(data.submission);
        if (data.analytics) {
          renderAnalytics(data.analytics);
        }

        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('content-container').style.display = 'block';
      } else {
        alert('Failed to load submission');
        window.location.href = '/admin/contacts';
      }
    } catch (error) {
      console.error('Error loading submission:', error);
      alert('Failed to load submission');
      window.location.href = '/admin/contacts';
    }
  }

  function renderSubmission(submission) {
    // Status and priority badges
    document.getElementById('status-badge').textContent = submission.status;
    document.getElementById('status-badge').className = `badge badge-${submission.status}`;
    document.getElementById('priority-badge').textContent = submission.priority;
    document.getElementById('priority-badge').className = `badge badge-${submission.priority}`;

    // Contact information
    document.getElementById('full-name').textContent = submission.full_name;
    document.getElementById('email-link').textContent = submission.email;
    document.getElementById('email-link').href = `mailto:${submission.email}`;

    if (submission.phone) {
      document.getElementById('phone').textContent = submission.phone;
      document.getElementById('phone-row').style.display = 'grid';
    }

    if (submission.company) {
      document.getElementById('company').textContent = submission.company;
      document.getElementById('company-row').style.display = 'grid';
    }

    // Project details
    document.getElementById('service-type').textContent = formatServiceType(submission.service_type);

    if (submission.budget_range) {
      document.getElementById('budget').textContent = formatBudgetRange(submission.budget_range);
      document.getElementById('budget-row').style.display = 'grid';
    }

    if (submission.project_timeline) {
      document.getElementById('timeline').textContent = formatTimeline(submission.project_timeline);
      document.getElementById('timeline-row').style.display = 'grid';
    }

    document.getElementById('description').textContent = submission.project_description;

    // Additional info
    if (submission.how_found) {
      document.getElementById('how-found').textContent = formatHowFound(submission.how_found);
      document.getElementById('how-found-row').style.display = 'grid';
    }

    document.getElementById('created-at').textContent = formatDateTime(submission.created_at);

    if (submission.responded_at) {
      document.getElementById('responded-at').textContent = formatDateTime(submission.responded_at);
      document.getElementById('responded-row').style.display = 'grid';
    }

    // Management form
    document.getElementById('status-select').value = submission.status;
    document.getElementById('priority-select').value = submission.priority;
    document.getElementById('assigned-to').value = submission.assigned_to || '';
    document.getElementById('notes').value = submission.notes || '';
  }

  function renderAnalytics(analytics) {
    document.getElementById('analytics-card').style.display = 'block';

    const timeSpent = analytics.time_spent_seconds
      ? `${Math.floor(analytics.time_spent_seconds / 60)}m ${analytics.time_spent_seconds % 60}s`
      : 'N/A';
    document.getElementById('time-spent').textContent = timeSpent;

    document.getElementById('steps-reached').textContent = `${analytics.step_reached}/${analytics.total_steps}`;
    document.getElementById('completed').textContent = analytics.completed ? 'Yes' : 'No';

    if (analytics.user_agent) {
      document.getElementById('user-agent').textContent = analytics.user_agent;
    }

    if (analytics.referrer) {
      document.getElementById('referrer').textContent = analytics.referrer;
      document.getElementById('referrer-row').style.display = 'grid';
    }

    if (analytics.utm_source || analytics.utm_medium || analytics.utm_campaign) {
      const utm = [];
      if (analytics.utm_source) utm.push(`Source: ${analytics.utm_source}`);
      if (analytics.utm_medium) utm.push(`Medium: ${analytics.utm_medium}`);
      if (analytics.utm_campaign) utm.push(`Campaign: ${analytics.utm_campaign}`);
      document.getElementById('utm-params').textContent = utm.join(' | ');
      document.getElementById('utm-row').style.display = 'grid';
    }
  }

  function formatServiceType(service) {
    const map = {
      'web-development': 'Web Development',
      'ui-ux-design': 'UI/UX Design',
      'branding': 'Branding & Identity',
      'seo-marketing': 'SEO & Marketing',
      'cloud-solutions': 'Cloud Solutions',
      'premium-support': 'Premium Support'
    };
    return map[service] || service;
  }

  function formatBudgetRange(budget) {
    const map = {
      'under-5k': 'Under GH₵5,000 ($415)',
      '5k-10k': 'GH₵5,000 - GH₵10,000 ($415 - $830)',
      '10k-20k': 'GH₵10,000 - GH₵20,000 ($830 - $1,660)',
      '20k-50k': 'GH₵20,000 - GH₵50,000 ($1,660 - $4,150)',
      'over-50k': 'Over GH₵50,000 ($4,150+)'
    };
    return map[budget] || budget;
  }

  function formatTimeline(timeline) {
    const map = {
      'urgent': 'Urgent (1-2 weeks)',
      'standard': 'Standard (3-4 weeks)',
      'flexible': 'Flexible (1-2 months)',
      'long-term': 'Long-term (3+ months)'
    };
    return map[timeline] || timeline;
  }

  function formatHowFound(howFound) {
    const map = {
      'google': 'Google Search',
      'social-media': 'Social Media',
      'referral': 'Referral',
      'advertising': 'Online Advertising',
      'event': 'Event/Conference',
      'other': 'Other'
    };
    return map[howFound] || howFound;
  }

  function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadSubmission();

    // Save button
    document.getElementById('save-btn')?.addEventListener('click', async () => {
      const status = (document.getElementById('status-select') as HTMLSelectElement).value;
      const priority = (document.getElementById('priority-select') as HTMLSelectElement).value;
      const assigned_to = (document.getElementById('assigned-to') as HTMLInputElement).value;
      const notes = (document.getElementById('notes') as HTMLTextAreaElement).value;

      try {
        const response = await fetch('/api/admin/contacts', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: submissionId,
            status,
            priority,
            assigned_to,
            notes
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('Changes saved successfully!');
          loadSubmission();
        } else {
          alert('Failed to save changes');
        }
      } catch (error) {
        console.error('Error saving changes:', error);
        alert('Failed to save changes');
      }
    });

    // Email button
    document.getElementById('email-btn')?.addEventListener('click', () => {
      if (currentSubmission) {
        window.location.href = `mailto:${currentSubmission.email}?subject=Re: Your Project Inquiry`;
      }
    });

    // Delete button
    document.getElementById('delete-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/contacts?id=${submissionId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          alert('Submission deleted successfully');
          window.location.href = '/admin/contacts';
        } else {
          alert('Failed to delete submission');
        }
      } catch (error) {
        console.error('Error deleting submission:', error);
        alert('Failed to delete submission');
      }
    });
  });
</script>
</BaseLayout>
