---
import BaseLayout from '@/layouts/BaseLayout.astro';
---

<BaseLayout title="Admin Dashboard" description="Site content management">
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <h2>Admin Portal</h2>
      </div>
      
      <nav class="sidebar-nav">
        <button class="nav-item active" data-section="hero">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          </svg>
          <span>Hero Section</span>
        </button>
        
        <button class="nav-item" data-section="services">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
          </svg>
          <span>Services</span>
        </button>
        
        <button class="nav-item" data-section="portfolio">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <span>Portfolio</span>
        </button>
        
        <button class="nav-item" data-section="settings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6m6-12h-6m-6 0h6M19.071 4.929L14.121 9.88m0 4.24l4.95 4.95M4.929 4.929l4.95 4.95m4.24 0l4.95 4.95"/>
          </svg>
          <span>Site Settings</span>
        </button>
      </nav>
      
      <button class="logout-btn" id="logout-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
        </svg>
        <span>Logout</span>
      </button>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1 id="section-title">Hero Section</h1>
        <button class="btn btn-primary" id="save-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          Save Changes
        </button>
      </div>

      <div class="admin-content">
        <div class="status-message" id="status-message"></div>

        <!-- Hero Section -->
        <div class="content-section active" id="section-hero">
          <div class="section-card">
            <h3>Hero Content</h3>
            
            <div class="form-group">
              <label>Main Title</label>
              <input type="text" id="hero_title" placeholder="Enter hero title" />
            </div>

            <div class="form-group">
              <label>Subtitle</label>
              <textarea id="hero_subtitle" rows="3" placeholder="Enter hero subtitle"></textarea>
            </div>

            <div class="stats-grid">
              <div class="form-group">
                <label>Stat 1 - Number</label>
                <input type="text" id="hero_stat1_number" placeholder="500+" />
              </div>
              <div class="form-group">
                <label>Stat 1 - Label</label>
                <input type="text" id="hero_stat1_label" placeholder="Projects Delivered" />
              </div>
              <div class="form-group">
                <label>Stat 2 - Number</label>
                <input type="text" id="hero_stat2_number" placeholder="98%" />
              </div>
              <div class="form-group">
                <label>Stat 2 - Label</label>
                <input type="text" id="hero_stat2_label" placeholder="Client Satisfaction" />
              </div>
              <div class="form-group">
                <label>Stat 3 - Number</label>
                <input type="text" id="hero_stat3_number" placeholder="50+" />
              </div>
              <div class="form-group">
                <label>Stat 3 - Label</label>
                <input type="text" id="hero_stat3_label" placeholder="Team Members" />
              </div>
            </div>
          </div>
        </div>

        <!-- Services Section -->
        <div class="content-section" id="section-services">
          <div class="section-card">
            <h3>Services</h3>
            <p class="section-description">Manage your service offerings</p>
            
            <div id="services-list">
              <div class="service-item">
                <input type="text" placeholder="Service title" />
                <textarea placeholder="Service description" rows="2"></textarea>
                <select>
                  <option value="code">Code Icon</option>
                  <option value="palette">Palette Icon</option>
                  <option value="sparkles">Sparkles Icon</option>
                  <option value="chart">Chart Icon</option>
                  <option value="cloud">Cloud Icon</option>
                  <option value="lightbulb">Lightbulb Icon</option>
                </select>
                <button class="btn-icon btn-danger">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>

            <button class="btn btn-secondary" id="add-service-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Service
            </button>
          </div>
        </div>

        <!-- Portfolio Section -->
        <div class="content-section" id="section-portfolio">
          <div class="section-card">
            <h3>Portfolio</h3>
            <p class="section-description">Manage your portfolio projects</p>
            
            <div id="portfolio-list">
              <div class="portfolio-item">
                <input type="text" placeholder="Project title" />
                <textarea placeholder="Project description" rows="2"></textarea>
                <input type="url" placeholder="Image URL" />
                <input type="url" placeholder="Project URL" />
                <button class="btn-icon btn-danger">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>

            <button class="btn btn-secondary" id="add-portfolio-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Project
            </button>
          </div>
        </div>

        <!-- Settings Section -->
        <div class="content-section" id="section-settings">
          <div class="section-card">
            <h3>Site Settings</h3>
            
            <div class="form-group">
              <label>Site Name</label>
              <input type="text" id="site_name" placeholder="Your Agency Name" />
            </div>

            <div class="form-group">
              <label>Tagline</label>
              <input type="text" id="site_tagline" placeholder="Crafting Digital Excellence" />
            </div>

            <div class="form-group">
              <label>Email</label>
              <input type="email" id="site_email" placeholder="hello@yoursite.com" />
            </div>

            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="site_phone" placeholder="+1 (555) 123-4567" />
            </div>

            <div class="form-group">
              <label>Logo URL</label>
              <input type="url" id="site_logo" placeholder="https://example.com/logo.png" />
              <small class="field-hint">URL to your logo image (PNG, SVG, or WEBP recommended)</small>
            </div>

            <div class="form-group">
              <label>Favicon URL</label>
              <input type="url" id="site_favicon" placeholder="https://example.com/favicon.svg" />
              <small class="field-hint">URL to your favicon (SVG or ICO format)</small>
            </div>

            <div class="logo-preview" id="logo-preview-container" style="display: none;">
              <h4>Logo Preview</h4>
              <div class="preview-box">
                <img id="logo-preview" alt="Logo preview" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</BaseLayout>

<style>
  .admin-layout {
    display: flex;
    min-height: 100vh;
    background: var(--color-bg-alt);
  }

  .admin-sidebar {
    width: 280px;
    background: var(--color-surface);
    border-right: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    left: 0;
    top: 0;
  }

  .sidebar-header {
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--color-border);
  }

  .sidebar-header h2 {
    font-size: 1.5rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0;
  }

  .sidebar-nav {
    flex: 1;
    padding: var(--spacing-md);
    overflow-y: auto;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    width: 100%;
    padding: 1rem;
    border: none;
    background: transparent;
    color: var(--color-text-muted);
    font-size: 1rem;
    font-weight: 500;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: 0.5rem;
    text-align: left;
  }

  .nav-item:hover {
    background: var(--color-bg-alt);
    color: var(--color-text);
  }

  .nav-item.active {
    background: var(--gradient-card);
    color: var(--color-primary);
  }

  .logout-btn {
    display: flex;
    align-items: center;
    gap: 1rem;
    width: 100%;
    padding: 1rem var(--spacing-xl);
    border: none;
    border-top: 1px solid var(--color-border);
    background: transparent;
    color: #ef4444;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .logout-btn:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  .admin-main {
    flex: 1;
    margin-left: 280px;
    padding: var(--spacing-2xl);
  }

  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
  }

  .admin-header h1 {
    font-size: 2rem;
    margin: 0;
  }

  .admin-content {
    max-width: 1200px;
  }

  .content-section {
    display: none;
  }

  .content-section.active {
    display: block;
  }

  .section-card {
    background: var(--color-surface);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    border: 1px solid var(--color-border);
    margin-bottom: var(--spacing-lg);
  }

  .section-card h3 {
    font-size: 1.5rem;
    margin-bottom: var(--spacing-md);
  }

  .section-description {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .form-group {
    margin-bottom: var(--spacing-md);
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-text);
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
    font-size: 1rem;
    font-family: var(--font-sans);
    transition: all var(--transition-fast);
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .form-group textarea {
    resize: vertical;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
  }

  .service-item,
  .portfolio-item {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: var(--color-bg-alt);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-sm);
  }

  .btn-icon {
    padding: 0.5rem;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .btn-danger:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }

  .status-message {
    padding: 1rem;
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-lg);
    text-align: center;
    display: none;
  }

  .status-message.success {
    display: block;
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .status-message.error {
    display: block;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .field-hint {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .logo-preview {
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
  }

  .logo-preview h4 {
    font-size: 1rem;
    margin-bottom: var(--spacing-md);
  }

  .preview-box {
    background: var(--color-bg-alt);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 120px;
  }

  .preview-box img {
    max-width: 100%;
    max-height: 100px;
    object-fit: contain;
  }

  @media (max-width: 1024px) {
    .admin-sidebar {
      width: 240px;
    }

    .admin-main {
      margin-left: 240px;
    }
  }

  @media (max-width: 768px) {
    .admin-sidebar {
      transform: translateX(-100%);
    }

    .admin-main {
      margin-left: 0;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Check authentication
  const token = localStorage.getItem('admin_token');
  if (!token) {
    window.location.href = '/admin/login';
  }

  // Navigation
  const navItems = document.querySelectorAll('.nav-item');
  const contentSections = document.querySelectorAll('.content-section');
  const sectionTitle = document.getElementById('section-title');

  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const section = item.dataset.section;
      
      // Update active nav item
      navItems.forEach(nav => nav.classList.remove('active'));
      item.classList.add('active');
      
      // Show corresponding content section
      contentSections.forEach(sec => sec.classList.remove('active'));
      document.getElementById(`section-${section}`)?.classList.add('active');
      
      // Update title
      if (sectionTitle) {
        sectionTitle.textContent = item.querySelector('span')?.textContent || '';
      }
    });
  });

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', () => {
    localStorage.removeItem('admin_token');
    window.location.href = '/admin/login';
  });

  // Load content from API
  async function loadContent() {
    try {
      const response = await fetch('/api/admin/content');
      const data = await response.json();

      if (data.success) {
        // Populate form fields with existing content
        Object.keys(data.content).forEach(key => {
          const element = document.getElementById(key);
          if (element) {
            element.value = data.content[key];
          }
        });

        // Update logo preview if logo URL exists
        if (data.content.site_logo) {
          updateLogoPreview(data.content.site_logo);
        }
      }
    } catch (error) {
      console.error('Error loading content:', error);
    }
  }

  // Logo preview functionality
  function updateLogoPreview(url: string) {
    const previewContainer = document.getElementById('logo-preview-container');
    const previewImg = document.getElementById('logo-preview') as HTMLImageElement;

    if (url && url.trim() !== '') {
      if (previewImg) {
        previewImg.src = url;
        previewImg.onerror = () => {
          if (previewContainer) previewContainer.style.display = 'none';
        };
        previewImg.onload = () => {
          if (previewContainer) previewContainer.style.display = 'block';
        };
      }
    } else {
      if (previewContainer) previewContainer.style.display = 'none';
    }
  }

  // Add event listener for logo URL input
  const logoInput = document.getElementById('site_logo') as HTMLInputElement;
  if (logoInput) {
    logoInput.addEventListener('input', (e) => {
      const url = (e.target as HTMLInputElement).value;
      updateLogoPreview(url);
    });
  }

  // Save changes
  document.getElementById('save-btn')?.addEventListener('click', async () => {
    const statusMessage = document.getElementById('status-message');
    const token = localStorage.getItem('admin_token');

    // Collect all form data
    const content: Record<string, string> = {};
    
    // Hero content
    ['hero_title', 'hero_subtitle', 'hero_stat1_number', 'hero_stat1_label',
     'hero_stat2_number', 'hero_stat2_label', 'hero_stat3_number', 'hero_stat3_label',
     'site_name', 'site_tagline', 'site_email', 'site_phone', 'site_logo', 'site_favicon'].forEach(id => {
      const element = document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement;
      if (element) {
        content[id] = element.value;
      }
    });

    try {
      const response = await fetch('/api/admin/content', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({ content }),
      });

      if (response.ok) {
        if (statusMessage) {
          statusMessage.className = 'status-message success';
          statusMessage.textContent = '✓ Changes saved successfully!';
          setTimeout(() => {
            statusMessage.style.display = 'none';
          }, 3000);
        }
      } else {
        throw new Error('Failed to save');
      }
    } catch (error) {
      if (statusMessage) {
        statusMessage.className = 'status-message error';
        statusMessage.textContent = '✗ Error saving changes. Please try again.';
      }
    }
  });

  // Initialize
  loadContent();
</script>

