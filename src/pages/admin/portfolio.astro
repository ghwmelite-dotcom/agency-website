---
import BaseLayout from '@/layouts/BaseLayout.astro';

export const prerender = false;

const title = 'Portfolio Projects';
---

<BaseLayout title={title} noLoader={true}>
  <div class="admin-container">
    <div class="admin-header">
      <div class="header-left">
        <a href="/admin/dashboard" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Back to Dashboard
        </a>
        <h1>{title}</h1>
      </div>
      <button id="add-project" class="button-primary">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add New Project
      </button>
    </div>

    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Projects</div>
        <div class="stat-value" id="stat-total">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Published</div>
        <div class="stat-value" id="stat-published">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Featured</div>
        <div class="stat-value" id="stat-featured">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Categories</div>
        <div class="stat-value" id="stat-categories">-</div>
      </div>
    </div>

    <div class="filters">
      <select id="category-filter" class="filter-select">
        <option value="all">All Categories</option>
      </select>
      <select id="status-filter" class="filter-select">
        <option value="all">All Status</option>
        <option value="published">Published</option>
        <option value="draft">Draft</option>
        <option value="featured">Featured</option>
      </select>
    </div>

    <div class="loading-state" id="loading-state">
      <div class="spinner"></div>
      <p>Loading projects...</p>
    </div>

    <div class="empty-state" id="empty-state" style="display: none;">
      <p>No projects found. Create your first project!</p>
    </div>

    <div class="projects-grid" id="projects-grid"></div>
  </div>

  <!-- Add/Edit Project Modal -->
  <div class="modal" id="project-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Add New Project</h2>
        <button class="modal-close" id="close-modal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form class="modal-form" id="project-form">
        <input type="hidden" id="project-id" />

        <div class="form-row">
          <div class="form-group">
            <label for="title">Project Title *</label>
            <input type="text" id="title" name="title" required />
          </div>
          <div class="form-group">
            <label for="subtitle">Subtitle</label>
            <input type="text" id="subtitle" name="subtitle" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <select id="category" name="category_id" required>
              <option value="">Select category</option>
            </select>
          </div>
          <div class="form-group">
            <label for="client-name">Client Name</label>
            <input type="text" id="client-name" name="client_name" />
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" name="description" rows="3" required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="featured-image">Featured Image URL</label>
            <input type="url" id="featured-image" name="featured_image" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label for="project-url">Project URL</label>
            <input type="url" id="project-url" name="project_url" placeholder="https://..." />
          </div>
        </div>

        <div class="form-section">
          <h3>Case Study Details</h3>
          <div class="form-group">
            <label for="challenge">Challenge</label>
            <textarea id="challenge" name="challenge" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="solution">Solution</label>
            <textarea id="solution" name="solution" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="results">Results</label>
            <textarea id="results" name="results" rows="3"></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3>Project Metrics</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="metric-1-label">Metric 1 Label</label>
              <input type="text" id="metric-1-label" name="metric_1_label" placeholder="e.g., Traffic Increase" />
            </div>
            <div class="form-group">
              <label for="metric-1-value">Metric 1 Value</label>
              <input type="text" id="metric-1-value" name="metric_1_value" placeholder="e.g., +150%" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="metric-2-label">Metric 2 Label</label>
              <input type="text" id="metric-2-label" name="metric_2_label" />
            </div>
            <div class="form-group">
              <label for="metric-2-value">Metric 2 Value</label>
              <input type="text" id="metric-2-value" name="metric_2_value" />
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="is-featured" name="is_featured" />
              <span>Featured Project</span>
            </label>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="is-published" name="is_published" checked />
              <span>Published</span>
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="button-secondary" id="cancel-btn">Cancel</button>
          <button type="submit" class="button-primary">
            <span class="button-text">Save Project</span>
            <span class="button-loading" style="display: none;">
              <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
              </svg>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<style>
  .admin-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
  .admin-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; }
  .header-left { flex: 1; }
  .back-link { display: flex; align-items: center; gap: 0.5rem; color: var(--color-primary); text-decoration: none; margin-bottom: 1rem; }
  h1 { font-size: 2rem; font-weight: 800; }

  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .stat-card { padding: 1.5rem; background: var(--color-surface); border: 2px solid var(--color-border); border-radius: 12px; }
  .stat-label { color: var(--color-text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem; }
  .stat-value { font-size: 2rem; font-weight: 800; color: var(--color-text); }

  .filters { display: flex; gap: 1rem; margin-bottom: 2rem; }
  .filter-select { padding: 0.75rem 1rem; background: var(--color-surface); border: 2px solid var(--color-border); border-radius: 8px; font-size: 1rem; flex: 1; max-width: 250px; }

  .button-primary { padding: 0.75rem 1.5rem; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
  .button-secondary { padding: 0.75rem 1.5rem; background: var(--color-surface); color: var(--color-text); border: 2px solid var(--color-border); border-radius: 8px; font-weight: 700; cursor: pointer; }

  .loading-state, .empty-state { text-align: center; padding: 3rem; }
  .spinner { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
  .project-card { background: var(--color-surface); border: 2px solid var(--color-border); border-radius: 12px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
  .project-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }

  .project-image { width: 100%; height: 200px; object-fit: cover; background: var(--color-border); }
  .project-content { padding: 1.5rem; }
  .project-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
  .project-title { font-weight: 700; font-size: 1.25rem; margin-bottom: 0.25rem; }
  .project-subtitle { color: var(--color-text-secondary); font-size: 0.875rem; }
  .project-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
  .badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
  .badge-category { background: rgba(99, 102, 241, 0.1); color: #6366f1; }
  .badge-featured { background: rgba(234, 179, 8, 0.1); color: #eab308; }
  .badge-draft { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

  .project-description { color: var(--color-text-secondary); font-size: 0.875rem; margin: 1rem 0; line-height: 1.6; }
  .project-actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); }
  .btn-edit, .btn-delete { flex: 1; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
  .btn-edit { background: var(--gradient-primary); color: white; }
  .btn-delete { background: #ef4444; color: white; }

  /* Modal */
  .modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem; }
  .modal-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
  .modal-content { position: relative; background: var(--color-background); border: 2px solid var(--color-border); border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 2px solid var(--color-border); }
  .modal-header h2 { font-size: 1.5rem; font-weight: 800; }
  .modal-close { background: none; border: none; cursor: pointer; color: var(--color-text); }

  .modal-form { padding: 1.5rem; }
  .form-section { margin: 2rem 0; padding: 1.5rem; background: var(--color-surface); border-radius: 8px; }
  .form-section h3 { font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-group { margin-bottom: 1rem; }
  .form-group label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text); }
  .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; background: var(--color-background); border: 2px solid var(--color-border); border-radius: 8px; font-size: 1rem; color: var(--color-text); }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--color-primary); }
  .checkbox-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
  .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }

  .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--color-border); }

  @media (max-width: 768px) {
    .projects-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .filters { flex-direction: column; }
    .filter-select { max-width: 100%; }
  }
</style>

<script>
  let categories: any[] = [];
  let currentEditId: number | null = null;

  async function loadCategories() {
    try {
      const response = await fetch('/api/admin/portfolio/categories');
      const data = await response.json();
      if (data.success) {
        categories = data.categories;

        // Populate category filter
        const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
        if (categoryFilter) {
          categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
            categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }

        // Populate category select in modal
        const categorySelect = document.getElementById('category') as HTMLSelectElement;
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="">Select category</option>' +
            categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }

  async function loadProjects() {
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const projectsGrid = document.getElementById('projects-grid');

    if (loadingState) loadingState.style.display = 'block';
    if (projectsGrid) projectsGrid.innerHTML = '';

    try {
      const categoryFilter = (document.getElementById('category-filter') as HTMLSelectElement)?.value || 'all';
      const statusFilter = (document.getElementById('status-filter') as HTMLSelectElement)?.value || 'all';

      const params = new URLSearchParams();
      if (categoryFilter !== 'all') params.append('category_id', categoryFilter);
      if (statusFilter !== 'all') params.append('status', statusFilter);

      const response = await fetch(`/api/admin/portfolio?${params}`);
      const data = await response.json();

      if (loadingState) loadingState.style.display = 'none';

      if (data.success && data.projects.length > 0) {
        if (emptyState) emptyState.style.display = 'none';
        renderProjects(data.projects);
        updateStats(data.stats);
      } else {
        if (emptyState) emptyState.style.display = 'block';
        updateStats({ total: 0, published: 0, featured: 0, categories: categories.length });
      }
    } catch (error) {
      console.error('Error loading projects:', error);
      if (loadingState) loadingState.style.display = 'none';
    }
  }

  function renderProjects(projects: any[]) {
    const grid = document.getElementById('projects-grid');
    if (!grid) return;

    grid.innerHTML = projects.map(project => {
      const category = categories.find(c => c.id === project.category_id);
      return `
        <div class="project-card">
          ${project.featured_image ? `<img src="${project.featured_image}" alt="${project.title}" class="project-image" />` : '<div class="project-image"></div>'}
          <div class="project-content">
            <div class="project-header">
              <div>
                <div class="project-title">${project.title}</div>
                ${project.subtitle ? `<div class="project-subtitle">${project.subtitle}</div>` : ''}
              </div>
            </div>
            <div class="project-badges">
              ${category ? `<span class="badge badge-category">${category.name}</span>` : ''}
              ${project.is_featured ? '<span class="badge badge-featured">Featured</span>' : ''}
              ${!project.is_published ? '<span class="badge badge-draft">Draft</span>' : ''}
            </div>
            ${project.description ? `<div class="project-description">${project.description.substring(0, 120)}${project.description.length > 120 ? '...' : ''}</div>` : ''}
            <div class="project-actions">
              <button class="btn-edit" onclick="editProject(${project.id})">Edit</button>
              <button class="btn-delete" onclick="deleteProject(${project.id})">Delete</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function updateStats(stats: any) {
    document.getElementById('stat-total')!.textContent = stats.total || '0';
    document.getElementById('stat-published')!.textContent = stats.published || '0';
    document.getElementById('stat-featured')!.textContent = stats.featured || '0';
    document.getElementById('stat-categories')!.textContent = stats.categories || categories.length;
  }

  // Modal controls
  const modal = document.getElementById('project-modal');
  const addButton = document.getElementById('add-project');
  const closeButton = document.getElementById('close-modal');
  const cancelButton = document.getElementById('cancel-btn');
  const projectForm = document.getElementById('project-form') as HTMLFormElement;

  addButton?.addEventListener('click', () => {
    currentEditId = null;
    projectForm?.reset();
    document.getElementById('modal-title')!.textContent = 'Add New Project';
    modal!.style.display = 'flex';
  });

  closeButton?.addEventListener('click', () => modal!.style.display = 'none');
  cancelButton?.addEventListener('click', () => modal!.style.display = 'none');
  modal?.querySelector('.modal-overlay')?.addEventListener('click', () => modal!.style.display = 'none');

  // Form submission
  projectForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(projectForm);
    const data: any = {};

    formData.forEach((value, key) => {
      if (key === 'is_featured' || key === 'is_published') {
        data[key] = document.getElementById(key.replace('_', '-'))?.checked ? 1 : 0;
      } else {
        data[key] = value;
      }
    });

    if (currentEditId) {
      data.id = currentEditId;
    }

    try {
      const url = currentEditId ? '/api/admin/portfolio' : '/api/admin/portfolio';
      const method = currentEditId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        modal!.style.display = 'none';
        loadProjects();
      } else {
        alert(result.error || 'Failed to save project');
      }
    } catch (error) {
      console.error('Error saving project:', error);
      alert('Failed to save project');
    }
  });

  (window as any).editProject = async (id: number) => {
    try {
      const response = await fetch(`/api/admin/portfolio/${id}`);
      const data = await response.json();

      if (data.success) {
        currentEditId = id;
        const project = data.project;

        // Populate form
        Object.keys(project).forEach(key => {
          const field = document.getElementById(key.replace('_', '-')) as HTMLInputElement;
          if (field) {
            if (field.type === 'checkbox') {
              field.checked = !!project[key];
            } else {
              field.value = project[key] || '';
            }
          }
        });

        document.getElementById('modal-title')!.textContent = 'Edit Project';
        modal!.style.display = 'flex';
      }
    } catch (error) {
      console.error('Error loading project:', error);
    }
  };

  (window as any).deleteProject = async (id: number) => {
    if (!confirm('Are you sure you want to delete this project?')) return;

    try {
      const response = await fetch(`/api/admin/portfolio/${id}`, { method: 'DELETE' });
      const data = await response.json();

      if (data.success) {
        loadProjects();
      } else {
        alert(data.error || 'Failed to delete project');
      }
    } catch (error) {
      console.error('Error deleting project:', error);
      alert('Failed to delete project');
    }
  };

  // Filters
  document.getElementById('category-filter')?.addEventListener('change', loadProjects);
  document.getElementById('status-filter')?.addEventListener('change', loadProjects);

  // Initialize
  loadCategories().then(() => loadProjects());
</script>
