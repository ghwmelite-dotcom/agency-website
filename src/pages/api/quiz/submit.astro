---
export const prerender = false;

import type { APIRoute } from 'astro';

export const POST: APIRoute = async ({ request, locals }) => {
  try {
    const data = await request.json();
    const { name, email, company, answers } = data;

    // Validate required fields
    if (!name || !email || !answers) {
      return new Response(JSON.stringify({ error: 'Missing required fields' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Get database
    const db = locals.runtime.env.DB;

    // Insert quiz lead into database
    await db
      .prepare(`
        INSERT INTO quiz_leads (
          name,
          email,
          company,
          goal,
          platform,
          audience,
          timeline,
          features,
          budget,
          involvement,
          created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
      `)
      .bind(
        name,
        email,
        company || null,
        answers.goal || null,
        answers.platform || null,
        answers.audience || null,
        answers.timeline || null,
        answers.features || null,
        answers.budget || null,
        answers.involvement || null
      )
      .run();

    // TODO: Send email notification to admin
    // TODO: Send thank you email to user with personalized recommendation

    return new Response(JSON.stringify({ success: true }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    console.error('Error submitting quiz:', error);
    return new Response(JSON.stringify({ error: 'Internal server error' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
};
