---
export const prerender = false;
import BaseLayout from '@/layouts/BaseLayout.astro';
import PMChatWidget from '@/components/PMChatWidget.astro';
import '../../../styles/client-project-detail.css';

// Set cache control headers to prevent caching
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate, max-age=0, s-maxage=0');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');
Astro.response.headers.set('CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Cloudflare-CDN-Cache-Control', 'no-store');
Astro.response.headers.set('Vary', '*');

// Build timestamp to force cache invalidation
const BUILD_VERSION = '20250109-v5';

const { id } = Astro.params;
---

<BaseLayout title="Project Details" description="Client project details">
  <!-- Build Version: {BUILD_VERSION} -->
  <main class="project-detail-page" data-version={BUILD_VERSION}>
    <div class="page-background">
      <div class="gradient-orb orb-1"></div>
      <div class="gradient-orb orb-2"></div>
    </div>

    <div class="project-container">
      <div class="loading-state" id="loading-state">
        <div class="spinner"></div>
        <p>Loading project details...</p>
      </div>

      <div class="error-state" id="error-state" style="display: none;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h2>Failed to load project</h2>
        <p id="error-message">Please try again later</p>
        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
      </div>

      <div class="project-content" id="project-content" style="display: none;">
        <!-- Header -->
        <div class="project-header">
          <div class="header-top">
            <a href="/client/dashboard" class="back-link">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Back to Dashboard
            </a>
            <button class="btn btn-secondary" id="logout-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Logout
            </button>
          </div>

          <div class="header-content" id="header-content">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
          <div class="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="updates">Updates</button>
            <button class="tab-btn" data-tab="milestones">Milestones</button>
            <button class="tab-btn" data-tab="files">Files</button>
            <button class="tab-btn" data-tab="contracts">Contracts</button>
            <button class="tab-btn" data-tab="code-quality">Code Quality</button>
          </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content active" data-content="overview">
          <div class="overview-grid">
            <div class="info-card">
              <h3>Project Details</h3>
              <div id="project-details"></div>
            </div>

            <div class="info-card">
              <h3>Progress</h3>
              <div id="project-progress"></div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-content="updates">
          <div class="updates-timeline" id="updates-timeline">
            <!-- Updates will be loaded here -->
          </div>
        </div>

        <div class="tab-content" data-content="milestones">
          <div class="milestones-list" id="milestones-list">
            <!-- Milestones will be loaded here -->
          </div>
        </div>

        <div class="tab-content" data-content="files">
          <div class="files-section">
            <div class="files-header">
              <h3>Project Files</h3>
              <button class="btn btn-primary" id="upload-file-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload File
              </button>
            </div>
            <div class="files-list" id="files-list">
              <!-- Files will be loaded here -->
            </div>
          </div>
        </div>

        <div class="tab-content" data-content="contracts">
          <div class="contracts-list" id="contracts-list">
            <!-- Contracts will be loaded here -->
          </div>
        </div>

        <div class="tab-content" data-content="code-quality">
          <div class="code-quality-container">
            <!-- Loading State -->
            <div class="quality-loading" id="quality-loading">
              <div class="spinner"></div>
              <p>Loading code quality metrics...</p>
            </div>

            <!-- No Metrics State -->
            <div class="quality-empty" id="quality-empty" style="display: none;">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3>Coming Soon</h3>
              <p>Code quality metrics will be available once your project is in active development.</p>
            </div>

            <!-- Metrics Dashboard -->
            <div class="quality-dashboard" id="quality-dashboard" style="display: none;">
              <!-- Health Score Card -->
              <div class="health-score-card">
                <div class="health-score-header">
                  <h3>Overall Health Score</h3>
                  <div class="health-trend" id="health-trend"></div>
                </div>
                <div class="health-score-display">
                  <div class="health-score-circle" id="health-score-circle">
                    <svg width="200" height="200" viewBox="0 0 200 200">
                      <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12"/>
                      <circle id="health-progress-circle" cx="100" cy="100" r="90" fill="none" stroke-width="12"
                              stroke-dasharray="565.48" stroke-dashoffset="565.48"
                              transform="rotate(-90 100 100)" stroke-linecap="round"/>
                    </svg>
                    <div class="health-score-value">
                      <span id="health-score-number">0</span>
                      <span class="health-score-label">Health Score</span>
                    </div>
                  </div>
                  <div class="health-score-status" id="health-score-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Excellent</span>
                  </div>
                </div>
              </div>

              <!-- Key Metrics Grid -->
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-icon coverage">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Code Coverage</h4>
                    <div class="metric-value" id="coverage-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar" id="coverage-bar"></div>
                    </div>
                    <p class="metric-hint">Test coverage of codebase</p>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon security">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Security Score</h4>
                    <div class="metric-value" id="security-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar security" id="security-bar"></div>
                    </div>
                    <p class="metric-hint">Security vulnerability status</p>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon performance">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Performance Score</h4>
                    <div class="metric-value" id="performance-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar performance" id="performance-bar"></div>
                    </div>
                    <p class="metric-hint">Application performance rating</p>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon tests">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                      <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Test Pass Rate</h4>
                    <div class="metric-value" id="test-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar tests" id="test-bar"></div>
                    </div>
                    <p class="metric-hint" id="test-details">0 of 0 tests passing</p>
                  </div>
                </div>
              </div>

              <!-- Security Vulnerabilities -->
              <div class="vulnerabilities-section">
                <h3>Security Vulnerabilities</h3>
                <div class="vulnerabilities-grid" id="vulnerabilities-grid">
                  <div class="vulnerability-badge critical">
                    <div class="vuln-icon">!</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-critical">0</div>
                      <div class="vuln-label">Critical</div>
                    </div>
                  </div>
                  <div class="vulnerability-badge high">
                    <div class="vuln-icon">!</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-high">0</div>
                      <div class="vuln-label">High</div>
                    </div>
                  </div>
                  <div class="vulnerability-badge medium">
                    <div class="vuln-icon">!</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-medium">0</div>
                      <div class="vuln-label">Medium</div>
                    </div>
                  </div>
                  <div class="vulnerability-badge low">
                    <div class="vuln-icon">i</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-low">0</div>
                      <div class="vuln-label">Low</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Technical Debt & Uptime -->
              <div class="stats-row">
                <div class="stat-card">
                  <div class="stat-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <h4>Technical Debt</h4>
                  </div>
                  <div class="stat-value" id="tech-debt-value">0 hours</div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" id="tech-debt-bar"></div>
                  </div>
                  <p class="stat-hint">Estimated time to resolve tech debt</p>
                </div>

                <div class="stat-card">
                  <div class="stat-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    <h4>Uptime</h4>
                  </div>
                  <div class="stat-value" id="uptime-value">99.9%</div>
                  <div class="stat-badge success" id="uptime-status">
                    <span class="status-dot"></span>
                    Online
                  </div>
                  <p class="stat-hint">Average response time: <span id="response-time">0ms</span></p>
                </div>
              </div>

              <!-- Recent Deployments -->
              <div class="deployments-section">
                <h3>Recent Deployments</h3>
                <div class="deployments-timeline" id="deployments-timeline">
                  <!-- Deployments will be loaded here -->
                </div>
              </div>

              <!-- Code Quality Grade -->
              <div class="quality-grade-card">
                <h3>Code Quality Grade</h3>
                <div class="grade-display" id="grade-display">
                  <div class="grade-badge">A+</div>
                  <p>Your code meets industry best practices and standards</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload File Modal -->
    <div class="modal" id="upload-modal" style="display: none;">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Upload File</h3>
          <button class="modal-close" id="close-modal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <form id="upload-form">
          <div class="form-group">
            <label for="file-name">File Name</label>
            <input type="text" id="file-name" name="file_name" required placeholder="Enter file name">
          </div>
          <div class="form-group">
            <label for="file-url">File URL</label>
            <input type="url" id="file-url" name="file_url" required placeholder="https://example.com/file.pdf">
          </div>
          <div class="form-group">
            <label for="file-type">File Type</label>
            <select id="file-type" name="file_type">
              <option value="document">Document</option>
              <option value="image">Image</option>
              <option value="spreadsheet">Spreadsheet</option>
              <option value="presentation">Presentation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="file-category">Category</label>
            <select id="file-category" name="category">
              <option value="general">General</option>
              <option value="design">Design</option>
              <option value="development">Development</option>
              <option value="content">Content</option>
              <option value="legal">Legal</option>
            </select>
          </div>
          <div class="form-group">
            <label for="file-description">Description (Optional)</label>
            <textarea id="file-description" name="description" rows="3" placeholder="Add a description"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-upload">Cancel</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
          <div class="form-status" id="upload-status"></div>
        </form>
      </div>
    </div>

    <!-- PM Chat Widget -->
    <PMChatWidget projectId={id} />
  </main>
</BaseLayout>


<script define:vars={{ projectId: id }}>
  // Check authentication
  const clientToken = localStorage.getItem('client_token');
  if (!clientToken) {
    window.location.href = '/client/login';
  }

  // Logout functionality
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('client_token');
      localStorage.removeItem('client_user');
      window.location.href = '/client/login';
    });
  }

  // Tab functionality
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetTab = btn.getAttribute('data-tab');

      tabBtns.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));

      btn.classList.add('active');
      const targetContent = document.querySelector(`[data-content="${targetTab}"]`);
      if (targetContent) {
        targetContent.classList.add('active');
      }
    });
  });

  // Modal functionality
  const uploadModal = document.getElementById('upload-modal');
  const uploadBtn = document.getElementById('upload-file-btn');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelUploadBtn = document.getElementById('cancel-upload');

  if (uploadBtn) {
    uploadBtn.addEventListener('click', () => {
      if (uploadModal) uploadModal.style.display = 'flex';
    });
  }

  function closeModal() {
    if (uploadModal) uploadModal.style.display = 'none';
    const uploadForm = document.getElementById('upload-form');
    if (uploadForm) uploadForm.reset();
    const uploadStatus = document.getElementById('upload-status');
    if (uploadStatus) uploadStatus.style.display = 'none';
  }

  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeModal);
  }

  if (cancelUploadBtn) {
    cancelUploadBtn.addEventListener('click', closeModal);
  }

  // Close modal on overlay click
  if (uploadModal) {
    uploadModal.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeModal();
      }
    });
  }

  // Upload form
  const uploadForm = document.getElementById('upload-form');
  const uploadStatus = document.getElementById('upload-status');

  if (uploadForm) {
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(uploadForm);
      const data = {
        project_id: projectId,
        file_name: formData.get('file_name'),
        file_url: formData.get('file_url'),
        file_type: formData.get('file_type'),
        category: formData.get('category'),
        description: formData.get('description'),
      };

      try {
        const response = await fetch('/api/client/upload-file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${clientToken}`,
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          if (uploadStatus) {
            uploadStatus.className = 'form-status success';
            uploadStatus.textContent = 'File uploaded successfully!';
          }

          setTimeout(() => {
            closeModal();
            loadProjectDetails(); // Reload project details
          }, 1500);
        } else {
          if (uploadStatus) {
            uploadStatus.className = 'form-status error';
            uploadStatus.textContent = result.error || 'Failed to upload file';
          }
        }
      } catch (error) {
        if (uploadStatus) {
          uploadStatus.className = 'form-status error';
          uploadStatus.textContent = 'Connection error. Please try again.';
        }
      }
    });
  }

  // Load project details
  async function loadProjectDetails() {
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const projectContent = document.getElementById('project-content');
    const errorMessage = document.getElementById('error-message');

    try {
      const response = await fetch(`/api/client/project/${projectId}`, {
        headers: {
          'Authorization': `Bearer ${clientToken}`,
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch project details');
      }

      const result = await response.json();

      if (loadingState) loadingState.style.display = 'none';

      if (result.success && result.project) {
        if (projectContent) projectContent.style.display = 'block';

        const project = result.project;

        // Populate header
        const headerContent = document.getElementById('header-content');
        if (headerContent) {
          headerContent.innerHTML = `
            <h1 class="project-title">${escapeHtml(project.project_name)}</h1>
            <div class="project-meta-row">
              <div class="meta-item">
                <span class="meta-label">Status</span>
                <span class="meta-value">
                  <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                </span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Type</span>
                <span class="meta-value">${escapeHtml(project.project_type)}</span>
              </div>
              ${project.budget ? `
                <div class="meta-item">
                  <span class="meta-label">Budget</span>
                  <span class="meta-value">${escapeHtml(project.budget)}</span>
                </div>
              ` : ''}
              ${project.start_date ? `
                <div class="meta-item">
                  <span class="meta-label">Start Date</span>
                  <span class="meta-value">${formatDate(project.start_date)}</span>
                </div>
              ` : ''}
            </div>
          `;
        }

        // Populate overview
        const projectDetails = document.getElementById('project-details');
        if (projectDetails) {
          projectDetails.innerHTML = `
            ${project.description ? `
              <div class="detail-row">
                <span class="detail-label">Description</span>
                <span class="detail-value">${escapeHtml(project.description)}</span>
              </div>
            ` : ''}
            ${project.start_date ? `
              <div class="detail-row">
                <span class="detail-label">Start Date</span>
                <span class="detail-value">${formatDate(project.start_date)}</span>
              </div>
            ` : ''}
            ${project.estimated_completion ? `
              <div class="detail-row">
                <span class="detail-label">Estimated Completion</span>
                <span class="detail-value">${formatDate(project.estimated_completion)}</span>
              </div>
            ` : ''}
            ${project.actual_completion ? `
              <div class="detail-row">
                <span class="detail-label">Actual Completion</span>
                <span class="detail-value">${formatDate(project.actual_completion)}</span>
              </div>
            ` : ''}
          `;
        }

        const projectProgress = document.getElementById('project-progress');
        if (projectProgress) {
          projectProgress.innerHTML = `
            <div class="progress-section">
              <div class="progress-header">
                <span class="progress-label">Overall Progress</span>
                <span class="progress-value">${project.progress_percentage || 0}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${project.progress_percentage || 0}%"></div>
              </div>
            </div>
          `;
        }

        // Populate updates
        const updatesTimeline = document.getElementById('updates-timeline');
        if (updatesTimeline) {
          if (project.updates && project.updates.length > 0) {
            updatesTimeline.innerHTML = project.updates.map(update => `
              <div class="update-card ${update.update_type || 'general'}">
                <div class="update-header">
                  <h4 class="update-title">${escapeHtml(update.title)}</h4>
                  <span class="update-date">${formatDate(update.created_at)}</span>
                </div>
                <p class="update-description">${escapeHtml(update.description)}</p>
                <div class="update-meta">
                  <span>Type: ${formatStatus(update.update_type)}</span>
                  <span>By: ${escapeHtml(update.created_by)}</span>
                </div>
              </div>
            `).join('');
          } else {
            updatesTimeline.innerHTML = '<p class="empty-message">No updates yet</p>';
          }
        }

        // Populate milestones
        const milestonesList = document.getElementById('milestones-list');
        if (milestonesList) {
          if (project.milestones && project.milestones.length > 0) {
            milestonesList.innerHTML = project.milestones.map(milestone => `
              <div class="milestone-card">
                <div class="milestone-header">
                  <h4 class="milestone-title">${escapeHtml(milestone.title)}</h4>
                  <span class="milestone-status ${milestone.status}">${formatStatus(milestone.status)}</span>
                </div>
                ${milestone.description ? `
                  <p class="milestone-description">${escapeHtml(milestone.description)}</p>
                ` : ''}
                ${milestone.due_date ? `
                  <p class="milestone-date">Due: ${formatDate(milestone.due_date)}</p>
                ` : ''}
                ${milestone.completed_at ? `
                  <p class="milestone-date">Completed: ${formatDate(milestone.completed_at)}</p>
                ` : ''}
              </div>
            `).join('');
          } else {
            milestonesList.innerHTML = '<p class="empty-message">No milestones yet</p>';
          }
        }

        // Populate files
        const filesList = document.getElementById('files-list');
        if (filesList) {
          if (project.files && project.files.length > 0) {
            filesList.innerHTML = project.files.map(file => `
              <div class="file-item">
                <div class="file-info">
                  <div class="file-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                      <polyline points="13 2 13 9 20 9"/>
                    </svg>
                  </div>
                  <div class="file-details">
                    <div class="file-name">${escapeHtml(file.file_name)}</div>
                    <div class="file-meta">
                      ${file.category ? formatStatus(file.category) + ' " ' : ''}
                      Uploaded ${formatDate(file.uploaded_at)}
                      ${file.uploaded_by ? ' by ' + escapeHtml(file.uploaded_by) : ''}
                    </div>
                  </div>
                </div>
                <div class="file-actions">
                  <a href="${escapeHtml(file.file_url)}" target="_blank" class="file-download">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download
                  </a>
                </div>
              </div>
            `).join('');
          } else {
            filesList.innerHTML = '<p class="empty-message">No files uploaded yet</p>';
          }
        }

        // Populate contracts
        const contractsList = document.getElementById('contracts-list');
        if (contractsList) {
          if (project.contracts && project.contracts.length > 0) {
            contractsList.innerHTML = project.contracts.map(contract => `
              <div class="contract-card">
                <div class="contract-header">
                  <h4 class="contract-title">${escapeHtml(contract.title)}</h4>
                  ${contract.amount ? `<span class="contract-amount">${escapeHtml(contract.amount)}</span>` : ''}
                </div>
                ${contract.description ? `
                  <p class="contract-description">${escapeHtml(contract.description)}</p>
                ` : ''}
                <div class="contract-actions">
                  <a href="${escapeHtml(contract.contract_url)}" target="_blank" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                      <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    View Contract
                  </a>
                  <span class="status-badge ${contract.status}">${formatStatus(contract.status)}</span>
                  ${contract.signed_by_client ? `
                    <span class="status-badge completed">Signed</span>
                  ` : ''}
                </div>
              </div>
            `).join('');
          } else {
            contractsList.innerHTML = '<p class="empty-message">No contracts yet</p>';
          }
        }
      } else {
        throw new Error('Project not found');
      }
    } catch (error) {
      console.error('Error loading project:', error);
      if (loadingState) loadingState.style.display = 'none';
      if (errorState) errorState.style.display = 'flex';
      if (errorMessage) errorMessage.textContent = error.message || 'Please try again later';
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatStatus(status) {
    return status.replace(/_/g, ' ');
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  // Code Quality Tab - Load metrics when tab is clicked
  tabBtns.forEach(btn => {
    const originalListener = btn.onclick;
    btn.addEventListener('click', () => {
      const targetTab = btn.getAttribute('data-tab');
      if (targetTab === 'code-quality') {
        loadCodeQualityMetrics();
      }
    });
  });

  // Load Code Quality Metrics
  async function loadCodeQualityMetrics() {
    const qualityLoading = document.getElementById('quality-loading');
    const qualityEmpty = document.getElementById('quality-empty');
    const qualityDashboard = document.getElementById('quality-dashboard');

    try {
      const response = await fetch(`/api/client/code-quality?project_id=${projectId}`, {
        headers: {
          'Authorization': `Bearer ${clientToken}`,
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch code quality metrics');
      }

      const result = await response.json();

      if (qualityLoading) qualityLoading.style.display = 'none';

      if (!result.metrics || !result.metrics.latest) {
        // No metrics available
        if (qualityEmpty) qualityEmpty.style.display = 'flex';
        return;
      }

      // Metrics available - show dashboard
      if (qualityDashboard) qualityDashboard.style.display = 'block';

      const metrics = result.metrics.latest;
      const healthScore = result.metrics.healthScore || 0;
      const trend = result.metrics.trend;

      // Update health score
      updateHealthScore(healthScore, trend);

      // Update key metrics
      updateMetricCard('coverage', metrics.code_coverage_percent || 0);
      updateMetricCard('security', metrics.security_score || 0);
      updateMetricCard('performance', metrics.performance_score || 0);
      updateMetricCard('test', metrics.test_pass_rate || 0);

      // Update test details
      const testDetails = document.getElementById('test-details');
      if (testDetails) {
        const passing = metrics.passing_tests || 0;
        const total = metrics.total_tests || 0;
        testDetails.textContent = `${passing} of ${total} tests passing`;
      }

      // Update vulnerabilities
      updateVulnerabilities(metrics);

      // Update technical debt
      updateTechnicalDebt(metrics.technical_debt_hours || 0);

      // Update uptime
      updateUptime(metrics.uptime_percent || 100, metrics.response_time_ms || 0);

      // Update deployments
      updateDeployments(result.metrics.deployments || []);

      // Update code quality grade
      updateCodeGrade(metrics.code_quality_grade || 'C');

    } catch (error) {
      console.error('Error loading code quality metrics:', error);
      if (qualityLoading) qualityLoading.style.display = 'none';
      if (qualityEmpty) qualityEmpty.style.display = 'flex';
    }
  }

  function updateHealthScore(score, trend) {
    const scoreNumber = document.getElementById('health-score-number');
    const progressCircle = document.getElementById('health-progress-circle');
    const statusText = document.querySelector('.health-score-status .status-text');
    const statusDot = document.querySelector('.health-score-status .status-dot');
    const trendElement = document.getElementById('health-trend');

    if (scoreNumber) {
      scoreNumber.textContent = score;
    }

    // Animate circle
    if (progressCircle) {
      const circumference = 2 * Math.PI * 90;
      const offset = circumference - (score / 100) * circumference;
      progressCircle.style.strokeDashoffset = offset;

      // Color based on score
      if (score >= 80) {
        progressCircle.style.stroke = '#10b981';
      } else if (score >= 60) {
        progressCircle.style.stroke = '#f59e0b';
      } else {
        progressCircle.style.stroke = '#ef4444';
      }
    }

    // Update status
    if (statusText) {
      if (score >= 80) {
        statusText.textContent = 'Excellent';
        if (statusDot) statusDot.style.background = '#10b981';
      } else if (score >= 60) {
        statusText.textContent = 'Good';
        if (statusDot) statusDot.style.background = '#f59e0b';
      } else {
        statusText.textContent = 'Needs Improvement';
        if (statusDot) statusDot.style.background = '#ef4444';
      }
    }

    // Update trend
    if (trendElement && trend) {
      const arrow = trend.direction === 'up' ? '↑' : trend.direction === 'down' ? '↓' : '→';
      trendElement.innerHTML = `${arrow} ${trend.value}% from last week`;
      trendElement.className = `health-trend ${trend.direction}`;
    }
  }

  function updateMetricCard(type, value) {
    const valueElement = document.getElementById(`${type}-value`);
    const barElement = document.getElementById(`${type}-bar`);

    if (valueElement) {
      valueElement.textContent = `${value}%`;
    }

    if (barElement) {
      barElement.style.width = `${value}%`;
    }
  }

  function updateVulnerabilities(metrics) {
    const critical = document.getElementById('vuln-critical');
    const high = document.getElementById('vuln-high');
    const medium = document.getElementById('vuln-medium');
    const low = document.getElementById('vuln-low');

    if (critical) critical.textContent = metrics.vulnerabilities_critical || 0;
    if (high) high.textContent = metrics.vulnerabilities_high || 0;
    if (medium) medium.textContent = metrics.vulnerabilities_medium || 0;
    if (low) low.textContent = metrics.vulnerabilities_low || 0;
  }

  function updateTechnicalDebt(hours) {
    const valueElement = document.getElementById('tech-debt-value');
    const barElement = document.getElementById('tech-debt-bar');

    if (valueElement) {
      valueElement.textContent = `${hours.toFixed(1)} hours`;
    }

    if (barElement) {
      // Cap at 100 hours for visualization
      const percentage = Math.min((hours / 100) * 100, 100);
      barElement.style.width = `${percentage}%`;
    }
  }

  function updateUptime(uptime, responseTime) {
    const uptimeValue = document.getElementById('uptime-value');
    const uptimeStatus = document.getElementById('uptime-status');
    const responseTimeSpan = document.getElementById('response-time');

    if (uptimeValue) {
      uptimeValue.textContent = `${uptime.toFixed(1)}%`;
    }

    if (uptimeStatus) {
      if (uptime >= 99) {
        uptimeStatus.innerHTML = '<span class="status-dot" style="background: #10b981;"></span> Online';
        uptimeStatus.className = 'stat-badge success';
      } else {
        uptimeStatus.innerHTML = '<span class="status-dot" style="background: #f59e0b;"></span> Degraded';
        uptimeStatus.style.color = '#f59e0b';
      }
    }

    if (responseTimeSpan) {
      responseTimeSpan.textContent = `${responseTime}ms`;
    }
  }

  function updateDeployments(deployments) {
    const timeline = document.getElementById('deployments-timeline');
    if (!timeline) return;

    if (deployments.length === 0) {
      timeline.innerHTML = '<p class="empty-message">No deployments yet</p>';
      return;
    }

    timeline.innerHTML = deployments.map(deployment => {
      const statusClass = deployment.status || 'success';
      const statusIcon = statusClass === 'success' ? '✓' : '✗';
      const deployedDate = new Date(deployment.deployed_at);
      const formattedDate = deployedDate.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <div class="deployment-item ${statusClass}">
          <div class="deployment-status-icon ${statusClass}">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${statusClass === 'success'
                ? '<polyline points="20 6 9 17 4 12"/>'
                : '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'}
            </svg>
          </div>
          <div class="deployment-info">
            <div class="deployment-header">
              <span class="deployment-version">${escapeHtml(deployment.version || 'v1.0.0')}</span>
              <span class="deployment-time">${formattedDate}</span>
            </div>
            <div class="deployment-details">
              <span class="deployment-detail">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
                ${escapeHtml(deployment.branch || 'main')}
              </span>
              <span class="deployment-detail">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                ${deployment.duration_seconds || 0}s
              </span>
              <span class="deployment-detail">By ${escapeHtml(deployment.deployed_by || 'admin')}</span>
            </div>
            ${deployment.commit_message ? `<div class="deployment-message">"${escapeHtml(deployment.commit_message)}"</div>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function updateCodeGrade(grade) {
    const gradeDisplay = document.getElementById('grade-display');
    if (!gradeDisplay) return;

    const gradeBadge = gradeDisplay.querySelector('.grade-badge');
    const gradeText = gradeDisplay.querySelector('p');

    if (gradeBadge) {
      gradeBadge.textContent = grade;

      // Update colors based on grade
      const gradeColors = {
        'A+': { bg: 'linear-gradient(135deg, #10b981, #059669)', shadow: 'rgba(16, 185, 129, 0.4)' },
        'A': { bg: 'linear-gradient(135deg, #10b981, #059669)', shadow: 'rgba(16, 185, 129, 0.4)' },
        'B': { bg: 'linear-gradient(135deg, #3b82f6, #2563eb)', shadow: 'rgba(59, 130, 246, 0.4)' },
        'C': { bg: 'linear-gradient(135deg, #f59e0b, #d97706)', shadow: 'rgba(245, 158, 11, 0.4)' },
        'D': { bg: 'linear-gradient(135deg, #ef4444, #dc2626)', shadow: 'rgba(239, 68, 68, 0.4)' },
        'F': { bg: 'linear-gradient(135deg, #7f1d1d, #991b1b)', shadow: 'rgba(127, 29, 29, 0.4)' }
      };

      const colors = gradeColors[grade] || gradeColors['C'];
      gradeBadge.style.background = colors.bg;
      gradeBadge.style.boxShadow = `0 10px 30px ${colors.shadow}`;
    }

    if (gradeText) {
      const gradeMessages = {
        'A+': 'Your code exceeds industry best practices and standards',
        'A': 'Your code meets industry best practices and standards',
        'B': 'Your code is good with minor areas for improvement',
        'C': 'Your code is acceptable but has room for improvement',
        'D': 'Your code needs significant improvement',
        'F': 'Your code requires immediate attention'
      };

      gradeText.textContent = gradeMessages[grade] || gradeMessages['C'];
    }
  }

  // Load project on page load
  loadProjectDetails();
</script>
