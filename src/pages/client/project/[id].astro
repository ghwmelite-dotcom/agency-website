---
export const prerender = false;
import BaseLayout from '@/layouts/BaseLayout.astro';
import PMChatWidget from '@/components/PMChatWidget.astro';
const { id } = Astro.params;
---

<BaseLayout title="Project Details" description="Client project details">
  <main class="project-detail-page">
    <div class="page-background">
      <div class="gradient-orb orb-1"></div>
      <div class="gradient-orb orb-2"></div>
    </div>

    <div class="project-container">
      <div class="loading-state" id="loading-state">
        <div class="spinner"></div>
        <p>Loading project details...</p>
      </div>

      <div class="error-state" id="error-state" style="display: none;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h2>Failed to load project</h2>
        <p id="error-message">Please try again later</p>
        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
      </div>

      <div class="project-content" id="project-content" style="display: none;">
        <!-- Header -->
        <div class="project-header">
          <div class="header-top">
            <a href="/client/dashboard" class="back-link">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
              Back to Dashboard
            </a>
            <button class="btn btn-secondary" id="logout-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Logout
            </button>
          </div>

          <div class="header-content" id="header-content">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
          <div class="tabs">
            <button class="tab-btn active" data-tab="overview">Overview</button>
            <button class="tab-btn" data-tab="updates">Updates</button>
            <button class="tab-btn" data-tab="milestones">Milestones</button>
            <button class="tab-btn" data-tab="files">Files</button>
            <button class="tab-btn" data-tab="contracts">Contracts</button>
            <button class="tab-btn" data-tab="code-quality">Code Quality</button>
          </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content active" data-content="overview">
          <div class="overview-grid">
            <div class="info-card">
              <h3>Project Details</h3>
              <div id="project-details"></div>
            </div>

            <div class="info-card">
              <h3>Progress</h3>
              <div id="project-progress"></div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-content="updates">
          <div class="updates-timeline" id="updates-timeline">
            <!-- Updates will be loaded here -->
          </div>
        </div>

        <div class="tab-content" data-content="milestones">
          <div class="milestones-list" id="milestones-list">
            <!-- Milestones will be loaded here -->
          </div>
        </div>

        <div class="tab-content" data-content="files">
          <div class="files-section">
            <div class="files-header">
              <h3>Project Files</h3>
              <button class="btn btn-primary" id="upload-file-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload File
              </button>
            </div>
            <div class="files-list" id="files-list">
              <!-- Files will be loaded here -->
            </div>
          </div>
        </div>

        <div class="tab-content" data-content="contracts">
          <div class="contracts-list" id="contracts-list">
            <!-- Contracts will be loaded here -->
          </div>
        </div>

        <div class="tab-content" data-content="code-quality">
          <div class="code-quality-container">
            <!-- Loading State -->
            <div class="quality-loading" id="quality-loading">
              <div class="spinner"></div>
              <p>Loading code quality metrics...</p>
            </div>

            <!-- No Metrics State -->
            <div class="quality-empty" id="quality-empty" style="display: none;">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <h3>Coming Soon</h3>
              <p>Code quality metrics will be available once your project is in active development.</p>
            </div>

            <!-- Metrics Dashboard -->
            <div class="quality-dashboard" id="quality-dashboard" style="display: none;">
              <!-- Health Score Card -->
              <div class="health-score-card">
                <div class="health-score-header">
                  <h3>Overall Health Score</h3>
                  <div class="health-trend" id="health-trend"></div>
                </div>
                <div class="health-score-display">
                  <div class="health-score-circle" id="health-score-circle">
                    <svg width="200" height="200" viewBox="0 0 200 200">
                      <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12"/>
                      <circle id="health-progress-circle" cx="100" cy="100" r="90" fill="none" stroke-width="12"
                              stroke-dasharray="565.48" stroke-dashoffset="565.48"
                              transform="rotate(-90 100 100)" stroke-linecap="round"/>
                    </svg>
                    <div class="health-score-value">
                      <span id="health-score-number">0</span>
                      <span class="health-score-label">Health Score</span>
                    </div>
                  </div>
                  <div class="health-score-status" id="health-score-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Excellent</span>
                  </div>
                </div>
              </div>

              <!-- Key Metrics Grid -->
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-icon coverage">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Code Coverage</h4>
                    <div class="metric-value" id="coverage-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar" id="coverage-bar"></div>
                    </div>
                    <p class="metric-hint">Test coverage of codebase</p>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon security">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Security Score</h4>
                    <div class="metric-value" id="security-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar security" id="security-bar"></div>
                    </div>
                    <p class="metric-hint">Security vulnerability status</p>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon performance">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Performance Score</h4>
                    <div class="metric-value" id="performance-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar performance" id="performance-bar"></div>
                    </div>
                    <p class="metric-hint">Application performance rating</p>
                  </div>
                </div>

                <div class="metric-card">
                  <div class="metric-icon tests">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                      <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                  </div>
                  <div class="metric-content">
                    <h4>Test Pass Rate</h4>
                    <div class="metric-value" id="test-value">0%</div>
                    <div class="metric-progress">
                      <div class="metric-progress-bar tests" id="test-bar"></div>
                    </div>
                    <p class="metric-hint" id="test-details">0 of 0 tests passing</p>
                  </div>
                </div>
              </div>

              <!-- Security Vulnerabilities -->
              <div class="vulnerabilities-section">
                <h3>Security Vulnerabilities</h3>
                <div class="vulnerabilities-grid" id="vulnerabilities-grid">
                  <div class="vulnerability-badge critical">
                    <div class="vuln-icon">!</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-critical">0</div>
                      <div class="vuln-label">Critical</div>
                    </div>
                  </div>
                  <div class="vulnerability-badge high">
                    <div class="vuln-icon">!</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-high">0</div>
                      <div class="vuln-label">High</div>
                    </div>
                  </div>
                  <div class="vulnerability-badge medium">
                    <div class="vuln-icon">!</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-medium">0</div>
                      <div class="vuln-label">Medium</div>
                    </div>
                  </div>
                  <div class="vulnerability-badge low">
                    <div class="vuln-icon">i</div>
                    <div class="vuln-content">
                      <div class="vuln-count" id="vuln-low">0</div>
                      <div class="vuln-label">Low</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Technical Debt & Uptime -->
              <div class="stats-row">
                <div class="stat-card">
                  <div class="stat-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <h4>Technical Debt</h4>
                  </div>
                  <div class="stat-value" id="tech-debt-value">0 hours</div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill" id="tech-debt-bar"></div>
                  </div>
                  <p class="stat-hint">Estimated time to resolve tech debt</p>
                </div>

                <div class="stat-card">
                  <div class="stat-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    <h4>Uptime</h4>
                  </div>
                  <div class="stat-value" id="uptime-value">99.9%</div>
                  <div class="stat-badge success" id="uptime-status">
                    <span class="status-dot"></span>
                    Online
                  </div>
                  <p class="stat-hint">Average response time: <span id="response-time">0ms</span></p>
                </div>
              </div>

              <!-- Recent Deployments -->
              <div class="deployments-section">
                <h3>Recent Deployments</h3>
                <div class="deployments-timeline" id="deployments-timeline">
                  <!-- Deployments will be loaded here -->
                </div>
              </div>

              <!-- Code Quality Grade -->
              <div class="quality-grade-card">
                <h3>Code Quality Grade</h3>
                <div class="grade-display" id="grade-display">
                  <div class="grade-badge">A+</div>
                  <p>Your code meets industry best practices and standards</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload File Modal -->
    <div class="modal" id="upload-modal" style="display: none;">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Upload File</h3>
          <button class="modal-close" id="close-modal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <form id="upload-form">
          <div class="form-group">
            <label for="file-name">File Name</label>
            <input type="text" id="file-name" name="file_name" required placeholder="Enter file name">
          </div>
          <div class="form-group">
            <label for="file-url">File URL</label>
            <input type="url" id="file-url" name="file_url" required placeholder="https://example.com/file.pdf">
          </div>
          <div class="form-group">
            <label for="file-type">File Type</label>
            <select id="file-type" name="file_type">
              <option value="document">Document</option>
              <option value="image">Image</option>
              <option value="spreadsheet">Spreadsheet</option>
              <option value="presentation">Presentation</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="file-category">Category</label>
            <select id="file-category" name="category">
              <option value="general">General</option>
              <option value="design">Design</option>
              <option value="development">Development</option>
              <option value="content">Content</option>
              <option value="legal">Legal</option>
            </select>
          </div>
          <div class="form-group">
            <label for="file-description">Description (Optional)</label>
            <textarea id="file-description" name="description" rows="3" placeholder="Add a description"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-upload">Cancel</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
          <div class="form-status" id="upload-status"></div>
        </form>
      </div>
    </div>

    <!-- PM Chat Widget -->
    <PMChatWidget projectId={id} />
  </main>
</BaseLayout>

<style>
  .project-detail-page {
    min-height: 100vh;
    position: relative;
    padding: 2rem;
  }

  .page-background {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg,
      #0f172a 0%,
      #1e293b 50%,
      #334155 100%
    );
    z-index: -1;
  }

  :global(.dark) .page-background {
    background: linear-gradient(135deg,
      #0a0a0a 0%,
      #1a1a1a 50%,
      #2a2a2a 100%
    );
  }

  .gradient-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.3;
    animation: float 25s infinite ease-in-out;
  }

  .orb-1 {
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.4), transparent);
    top: -20%;
    right: -10%;
  }

  .orb-2 {
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent);
    bottom: -20%;
    left: -10%;
    animation-delay: 12s;
  }

  @keyframes float {
    0%, 100% {
      transform: translate(0, 0) scale(1);
    }
    33% {
      transform: translate(50px, -50px) scale(1.1);
    }
    66% {
      transform: translate(-30px, 30px) scale(0.9);
    }
  }

  .project-container {
    max-width: 1400px;
    margin: 0 auto;
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .loading-state,
  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
    color: white;
    min-height: 60vh;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1.5rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .error-state svg {
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 1.5rem;
  }

  .error-state h2 {
    font-size: 1.75rem;
    margin-bottom: 0.75rem;
    color: white;
  }

  .error-state p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
  }

  .project-header {
    margin-bottom: 2rem;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    font-weight: 500;
    transition: all var(--transition-fast);
  }

  .back-link:hover {
    color: white;
    transform: translateX(-4px);
  }

  .header-content {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }

  .project-title {
    font-size: 2.5rem;
    color: white;
    margin-bottom: 1rem;
    font-weight: 700;
  }

  .project-meta-row {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
  }

  .meta-label {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
  }

  .meta-value {
    font-size: 1rem;
    color: white;
    font-weight: 600;
  }

  .status-badge {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .status-badge.in_progress {
    background: rgba(59, 130, 246, 0.2);
    color: #93c5fd;
  }

  .status-badge.completed {
    background: rgba(16, 185, 129, 0.2);
    color: #6ee7b7;
  }

  .status-badge.pending {
    background: rgba(245, 158, 11, 0.2);
    color: #fcd34d;
  }

  .status-badge.on_hold {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
  }

  .tabs-container {
    margin-bottom: 2rem;
  }

  .tabs {
    display: flex;
    gap: 1rem;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow-x: auto;
  }

  .tab-btn {
    padding: 0.875rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
  }

  .tab-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    color: white;
  }

  .tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease-out;
  }

  .overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
  }

  .info-card {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .info-card h3 {
    font-size: 1.5rem;
    color: white;
    margin-bottom: 1.5rem;
    font-weight: 700;
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .detail-row:last-child {
    border-bottom: none;
  }

  .detail-label {
    color: rgba(255, 255, 255, 0.6);
  }

  .detail-value {
    color: white;
    font-weight: 600;
  }

  .progress-section {
    margin-top: 1.5rem;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .progress-label {
    color: rgba(255, 255, 255, 0.7);
  }

  .progress-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
  }

  .progress-bar {
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 50px;
    transition: width 1s ease-out;
  }

  .updates-timeline {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .update-card {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-left: 4px solid;
    position: relative;
  }

  .update-card.progress {
    border-left-color: #667eea;
  }

  .update-card.milestone {
    border-left-color: #10b981;
  }

  .update-card.issue {
    border-left-color: #ef4444;
  }

  .update-card.general {
    border-left-color: #8b5cf6;
  }

  .update-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
  }

  .update-title {
    font-size: 1.25rem;
    color: white;
    font-weight: 700;
  }

  .update-date {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .update-description {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
  }

  .update-meta {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .milestones-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .milestone-card {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .milestone-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .milestone-title {
    font-size: 1.25rem;
    color: white;
    font-weight: 700;
  }

  .milestone-status {
    padding: 0.375rem 0.875rem;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .milestone-status.completed {
    background: rgba(16, 185, 129, 0.2);
    color: #6ee7b7;
  }

  .milestone-status.in_progress {
    background: rgba(59, 130, 246, 0.2);
    color: #93c5fd;
  }

  .milestone-status.pending {
    background: rgba(245, 158, 11, 0.2);
    color: #fcd34d;
  }

  .milestone-description {
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 1rem;
    line-height: 1.6;
  }

  .milestone-date {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .files-section {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .files-header h3 {
    font-size: 1.5rem;
    color: white;
    font-weight: 700;
  }

  .files-list {
    display: grid;
    gap: 1rem;
  }

  .file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all var(--transition-fast);
  }

  .file-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(4px);
  }

  .file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
  }

  .file-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    color: white;
  }

  .file-details {
    flex: 1;
  }

  .file-name {
    color: white;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .file-meta {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .file-actions {
    display: flex;
    gap: 0.5rem;
  }

  .file-download {
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all var(--transition-fast);
  }

  .file-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .contracts-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .contract-card {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .contract-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }

  .contract-title {
    font-size: 1.5rem;
    color: white;
    font-weight: 700;
  }

  .contract-amount {
    font-size: 1.25rem;
    color: #667eea;
    font-weight: 700;
  }

  .contract-description {
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .contract-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .empty-message {
    text-align: center;
    padding: 3rem 1rem;
    color: rgba(255, 255, 255, 0.5);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    position: relative;
    width: 100%;
    max-width: 600px;
    background: rgba(17, 24, 39, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 2rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .modal-header h3 {
    font-size: 1.5rem;
    color: white;
    font-weight: 700;
  }

  .modal-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    color: white;
    transform: rotate(90deg);
  }

  .modal-content form {
    padding: 2rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: white;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-size: 1rem;
    font-family: var(--font-sans);
    transition: all var(--transition-fast);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-group textarea {
    resize: vertical;
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }

  .form-status {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    display: none;
  }

  .form-status.success {
    display: block;
    background: rgba(16, 185, 129, 0.1);
    color: #6ee7b7;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .form-status.error {
    display: block;
    background: rgba(239, 68, 68, 0.1);
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  /* Code Quality Dashboard Styles */
  .code-quality-container {
    min-height: 400px;
  }

  .quality-loading,
  .quality-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
    color: white;
  }

  .quality-empty svg {
    color: rgba(255, 255, 255, 0.3);
    margin-bottom: 1.5rem;
  }

  .quality-empty h3 {
    font-size: 1.75rem;
    margin-bottom: 0.75rem;
  }

  .quality-empty p {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.1rem;
  }

  .quality-dashboard {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  /* Health Score Card */
  .health-score-card {
    padding: 2.5rem;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    backdrop-filter: blur(20px);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .health-score-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .health-score-header h3 {
    font-size: 1.75rem;
    color: white;
    font-weight: 700;
  }

  .health-trend {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50px;
    font-weight: 600;
  }

  .health-trend.up {
    color: #6ee7b7;
  }

  .health-trend.down {
    color: #fca5a5;
  }

  .health-trend.stable {
    color: #93c5fd;
  }

  .health-score-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3rem;
    flex-wrap: wrap;
  }

  .health-score-circle {
    position: relative;
    width: 200px;
    height: 200px;
  }

  .health-score-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  #health-score-number {
    display: block;
    font-size: 3.5rem;
    font-weight: 700;
    color: white;
    line-height: 1;
    margin-bottom: 0.5rem;
  }

  .health-score-label {
    display: block;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  #health-progress-circle {
    transition: stroke-dashoffset 1s ease-out, stroke 0.3s ease;
  }

  .health-score-status {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #6ee7b7;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .status-text {
    font-size: 1.25rem;
    font-weight: 600;
    color: white;
  }

  /* Metrics Grid */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .metric-card {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s;
  }

  .metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .metric-icon.coverage {
    background: linear-gradient(135deg, #10b981, #059669);
  }

  .metric-icon.security {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  }

  .metric-icon.performance {
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }

  .metric-icon.tests {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
  }

  .metric-content h4 {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
  }

  .metric-progress {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50px;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .metric-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    border-radius: 50px;
    transition: width 1s ease-out;
  }

  .metric-progress-bar.security {
    background: linear-gradient(90deg, #8b5cf6, #7c3aed);
  }

  .metric-progress-bar.performance {
    background: linear-gradient(90deg, #f59e0b, #d97706);
  }

  .metric-progress-bar.tests {
    background: linear-gradient(90deg, #3b82f6, #2563eb);
  }

  .metric-hint {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.5);
  }

  /* Vulnerabilities Section */
  .vulnerabilities-section {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .vulnerabilities-section h3 {
    font-size: 1.5rem;
    color: white;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .vulnerabilities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .vulnerability-badge {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    border: 1px solid;
  }

  .vulnerability-badge.critical {
    border-color: rgba(239, 68, 68, 0.5);
    background: rgba(239, 68, 68, 0.1);
  }

  .vulnerability-badge.high {
    border-color: rgba(245, 158, 11, 0.5);
    background: rgba(245, 158, 11, 0.1);
  }

  .vulnerability-badge.medium {
    border-color: rgba(251, 191, 36, 0.5);
    background: rgba(251, 191, 36, 0.1);
  }

  .vulnerability-badge.low {
    border-color: rgba(59, 130, 246, 0.5);
    background: rgba(59, 130, 246, 0.1);
  }

  .vuln-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
  }

  .critical .vuln-icon {
    background: #ef4444;
    color: white;
  }

  .high .vuln-icon {
    background: #f59e0b;
    color: white;
  }

  .medium .vuln-icon {
    background: #fbbf24;
    color: #1a1a1a;
  }

  .low .vuln-icon {
    background: #3b82f6;
    color: white;
  }

  .vuln-count {
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.25rem;
  }

  .vuln-label {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .stat-card {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .stat-header svg {
    color: #667eea;
  }

  .stat-header h4 {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
  }

  .stat-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50px;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .stat-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 50px;
    transition: width 1s ease-out;
  }

  .stat-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50px;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .stat-badge.success {
    color: #6ee7b7;
  }

  .stat-hint {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.5);
  }

  /* Deployments Section */
  .deployments-section {
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .deployments-section h3 {
    font-size: 1.5rem;
    color: white;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .deployments-timeline {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .deployment-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border-left: 4px solid;
    transition: all 0.3s;
  }

  .deployment-item:hover {
    background: rgba(255, 255, 255, 0.06);
  }

  .deployment-item.success {
    border-left-color: #10b981;
  }

  .deployment-item.failed {
    border-left-color: #ef4444;
  }

  .deployment-item.rolled_back {
    border-left-color: #f59e0b;
  }

  .deployment-status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .deployment-status-icon.success {
    background: rgba(16, 185, 129, 0.2);
    color: #6ee7b7;
  }

  .deployment-status-icon.failed {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
  }

  .deployment-info {
    flex: 1;
  }

  .deployment-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
  }

  .deployment-version {
    font-weight: 600;
    color: white;
    font-size: 1.1rem;
  }

  .deployment-time {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .deployment-details {
    display: flex;
    gap: 1.5rem;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .deployment-detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .deployment-message {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
    font-style: italic;
  }

  /* Quality Grade Card */
  .quality-grade-card {
    padding: 2rem;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .quality-grade-card h3 {
    font-size: 1.5rem;
    color: white;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  .grade-display {
    display: flex;
    align-items: center;
    gap: 2rem;
  }

  .grade-badge {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    background: linear-gradient(135deg, #10b981, #059669);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: 700;
    color: white;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
  }

  .grade-display p {
    flex: 1;
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
    line-height: 1.6;
  }

  @media (max-width: 768px) {
    .project-detail-page {
      padding: 1rem;
    }

    .header-top {
      flex-direction: column;
      gap: 1rem;
    }

    .project-title {
      font-size: 1.75rem;
    }

    .tabs {
      overflow-x: auto;
    }

    .overview-grid {
      grid-template-columns: 1fr;
    }

    .project-meta-row {
      flex-direction: column;
      gap: 1rem;
    }

    .modal-content {
      margin: 1rem;
    }

    .health-score-display {
      flex-direction: column;
    }

    .metrics-grid {
      grid-template-columns: 1fr;
    }

    .vulnerabilities-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .stats-row {
      grid-template-columns: 1fr;
    }

    .grade-display {
      flex-direction: column;
      text-align: center;
    }
  }
</style>

<script define:vars={{ projectId: id }}>
  // Check authentication
  const clientToken = localStorage.getItem('client_token');
  if (!clientToken) {
    window.location.href = '/client/login';
  }

  // Logout functionality
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('client_token');
      localStorage.removeItem('client_user');
      window.location.href = '/client/login';
    });
  }

  // Tab functionality
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetTab = btn.getAttribute('data-tab');

      tabBtns.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));

      btn.classList.add('active');
      const targetContent = document.querySelector(`[data-content="${targetTab}"]`);
      if (targetContent) {
        targetContent.classList.add('active');
      }
    });
  });

  // Modal functionality
  const uploadModal = document.getElementById('upload-modal');
  const uploadBtn = document.getElementById('upload-file-btn');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelUploadBtn = document.getElementById('cancel-upload');

  if (uploadBtn) {
    uploadBtn.addEventListener('click', () => {
      if (uploadModal) uploadModal.style.display = 'flex';
    });
  }

  function closeModal() {
    if (uploadModal) uploadModal.style.display = 'none';
    const uploadForm = document.getElementById('upload-form');
    if (uploadForm) uploadForm.reset();
    const uploadStatus = document.getElementById('upload-status');
    if (uploadStatus) uploadStatus.style.display = 'none';
  }

  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeModal);
  }

  if (cancelUploadBtn) {
    cancelUploadBtn.addEventListener('click', closeModal);
  }

  // Close modal on overlay click
  if (uploadModal) {
    uploadModal.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeModal();
      }
    });
  }

  // Upload form
  const uploadForm = document.getElementById('upload-form');
  const uploadStatus = document.getElementById('upload-status');

  if (uploadForm) {
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(uploadForm);
      const data = {
        project_id: projectId,
        file_name: formData.get('file_name'),
        file_url: formData.get('file_url'),
        file_type: formData.get('file_type'),
        category: formData.get('category'),
        description: formData.get('description'),
      };

      try {
        const response = await fetch('/api/client/upload-file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${clientToken}`,
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          if (uploadStatus) {
            uploadStatus.className = 'form-status success';
            uploadStatus.textContent = 'File uploaded successfully!';
          }

          setTimeout(() => {
            closeModal();
            loadProjectDetails(); // Reload project details
          }, 1500);
        } else {
          if (uploadStatus) {
            uploadStatus.className = 'form-status error';
            uploadStatus.textContent = result.error || 'Failed to upload file';
          }
        }
      } catch (error) {
        if (uploadStatus) {
          uploadStatus.className = 'form-status error';
          uploadStatus.textContent = 'Connection error. Please try again.';
        }
      }
    });
  }

  // Load project details
  async function loadProjectDetails() {
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const projectContent = document.getElementById('project-content');
    const errorMessage = document.getElementById('error-message');

    try {
      const response = await fetch(`/api/client/project/${projectId}`, {
        headers: {
          'Authorization': `Bearer ${clientToken}`,
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch project details');
      }

      const result = await response.json();

      if (loadingState) loadingState.style.display = 'none';

      if (result.success && result.project) {
        if (projectContent) projectContent.style.display = 'block';

        const project = result.project;

        // Populate header
        const headerContent = document.getElementById('header-content');
        if (headerContent) {
          headerContent.innerHTML = `
            <h1 class="project-title">${escapeHtml(project.project_name)}</h1>
            <div class="project-meta-row">
              <div class="meta-item">
                <span class="meta-label">Status</span>
                <span class="meta-value">
                  <span class="status-badge ${project.status}">${formatStatus(project.status)}</span>
                </span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Type</span>
                <span class="meta-value">${escapeHtml(project.project_type)}</span>
              </div>
              ${project.budget ? `
                <div class="meta-item">
                  <span class="meta-label">Budget</span>
                  <span class="meta-value">${escapeHtml(project.budget)}</span>
                </div>
              ` : ''}
              ${project.start_date ? `
                <div class="meta-item">
                  <span class="meta-label">Start Date</span>
                  <span class="meta-value">${formatDate(project.start_date)}</span>
                </div>
              ` : ''}
            </div>
          `;
        }

        // Populate overview
        const projectDetails = document.getElementById('project-details');
        if (projectDetails) {
          projectDetails.innerHTML = `
            ${project.description ? `
              <div class="detail-row">
                <span class="detail-label">Description</span>
                <span class="detail-value">${escapeHtml(project.description)}</span>
              </div>
            ` : ''}
            ${project.start_date ? `
              <div class="detail-row">
                <span class="detail-label">Start Date</span>
                <span class="detail-value">${formatDate(project.start_date)}</span>
              </div>
            ` : ''}
            ${project.estimated_completion ? `
              <div class="detail-row">
                <span class="detail-label">Estimated Completion</span>
                <span class="detail-value">${formatDate(project.estimated_completion)}</span>
              </div>
            ` : ''}
            ${project.actual_completion ? `
              <div class="detail-row">
                <span class="detail-label">Actual Completion</span>
                <span class="detail-value">${formatDate(project.actual_completion)}</span>
              </div>
            ` : ''}
          `;
        }

        const projectProgress = document.getElementById('project-progress');
        if (projectProgress) {
          projectProgress.innerHTML = `
            <div class="progress-section">
              <div class="progress-header">
                <span class="progress-label">Overall Progress</span>
                <span class="progress-value">${project.progress_percentage || 0}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${project.progress_percentage || 0}%"></div>
              </div>
            </div>
          `;
        }

        // Populate updates
        const updatesTimeline = document.getElementById('updates-timeline');
        if (updatesTimeline) {
          if (project.updates && project.updates.length > 0) {
            updatesTimeline.innerHTML = project.updates.map(update => `
              <div class="update-card ${update.update_type || 'general'}">
                <div class="update-header">
                  <h4 class="update-title">${escapeHtml(update.title)}</h4>
                  <span class="update-date">${formatDate(update.created_at)}</span>
                </div>
                <p class="update-description">${escapeHtml(update.description)}</p>
                <div class="update-meta">
                  <span>Type: ${formatStatus(update.update_type)}</span>
                  <span>By: ${escapeHtml(update.created_by)}</span>
                </div>
              </div>
            `).join('');
          } else {
            updatesTimeline.innerHTML = '<p class="empty-message">No updates yet</p>';
          }
        }

        // Populate milestones
        const milestonesList = document.getElementById('milestones-list');
        if (milestonesList) {
          if (project.milestones && project.milestones.length > 0) {
            milestonesList.innerHTML = project.milestones.map(milestone => `
              <div class="milestone-card">
                <div class="milestone-header">
                  <h4 class="milestone-title">${escapeHtml(milestone.title)}</h4>
                  <span class="milestone-status ${milestone.status}">${formatStatus(milestone.status)}</span>
                </div>
                ${milestone.description ? `
                  <p class="milestone-description">${escapeHtml(milestone.description)}</p>
                ` : ''}
                ${milestone.due_date ? `
                  <p class="milestone-date">Due: ${formatDate(milestone.due_date)}</p>
                ` : ''}
                ${milestone.completed_at ? `
                  <p class="milestone-date">Completed: ${formatDate(milestone.completed_at)}</p>
                ` : ''}
              </div>
            `).join('');
          } else {
            milestonesList.innerHTML = '<p class="empty-message">No milestones yet</p>';
          }
        }

        // Populate files
        const filesList = document.getElementById('files-list');
        if (filesList) {
          if (project.files && project.files.length > 0) {
            filesList.innerHTML = project.files.map(file => `
              <div class="file-item">
                <div class="file-info">
                  <div class="file-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                      <polyline points="13 2 13 9 20 9"/>
                    </svg>
                  </div>
                  <div class="file-details">
                    <div class="file-name">${escapeHtml(file.file_name)}</div>
                    <div class="file-meta">
                      ${file.category ? formatStatus(file.category) + ' " ' : ''}
                      Uploaded ${formatDate(file.uploaded_at)}
                      ${file.uploaded_by ? ' by ' + escapeHtml(file.uploaded_by) : ''}
                    </div>
                  </div>
                </div>
                <div class="file-actions">
                  <a href="${escapeHtml(file.file_url)}" target="_blank" class="file-download">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download
                  </a>
                </div>
              </div>
            `).join('');
          } else {
            filesList.innerHTML = '<p class="empty-message">No files uploaded yet</p>';
          }
        }

        // Populate contracts
        const contractsList = document.getElementById('contracts-list');
        if (contractsList) {
          if (project.contracts && project.contracts.length > 0) {
            contractsList.innerHTML = project.contracts.map(contract => `
              <div class="contract-card">
                <div class="contract-header">
                  <h4 class="contract-title">${escapeHtml(contract.title)}</h4>
                  ${contract.amount ? `<span class="contract-amount">${escapeHtml(contract.amount)}</span>` : ''}
                </div>
                ${contract.description ? `
                  <p class="contract-description">${escapeHtml(contract.description)}</p>
                ` : ''}
                <div class="contract-actions">
                  <a href="${escapeHtml(contract.contract_url)}" target="_blank" class="btn btn-primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                      <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    View Contract
                  </a>
                  <span class="status-badge ${contract.status}">${formatStatus(contract.status)}</span>
                  ${contract.signed_by_client ? `
                    <span class="status-badge completed">Signed</span>
                  ` : ''}
                </div>
              </div>
            `).join('');
          } else {
            contractsList.innerHTML = '<p class="empty-message">No contracts yet</p>';
          }
        }
      } else {
        throw new Error('Project not found');
      }
    } catch (error) {
      console.error('Error loading project:', error);
      if (loadingState) loadingState.style.display = 'none';
      if (errorState) errorState.style.display = 'flex';
      if (errorMessage) errorMessage.textContent = error.message || 'Please try again later';
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatStatus(status) {
    return status.replace(/_/g, ' ');
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  // Code Quality Tab - Load metrics when tab is clicked
  tabBtns.forEach(btn => {
    const originalListener = btn.onclick;
    btn.addEventListener('click', () => {
      const targetTab = btn.getAttribute('data-tab');
      if (targetTab === 'code-quality') {
        loadCodeQualityMetrics();
      }
    });
  });

  // Load Code Quality Metrics
  async function loadCodeQualityMetrics() {
    const qualityLoading = document.getElementById('quality-loading');
    const qualityEmpty = document.getElementById('quality-empty');
    const qualityDashboard = document.getElementById('quality-dashboard');

    try {
      const response = await fetch(`/api/client/code-quality?project_id=${projectId}`, {
        headers: {
          'Authorization': `Bearer ${clientToken}`,
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch code quality metrics');
      }

      const result = await response.json();

      if (qualityLoading) qualityLoading.style.display = 'none';

      if (!result.metrics || !result.metrics.latest) {
        // No metrics available
        if (qualityEmpty) qualityEmpty.style.display = 'flex';
        return;
      }

      // Metrics available - show dashboard
      if (qualityDashboard) qualityDashboard.style.display = 'block';

      const metrics = result.metrics.latest;
      const healthScore = result.metrics.healthScore || 0;
      const trend = result.metrics.trend;

      // Update health score
      updateHealthScore(healthScore, trend);

      // Update key metrics
      updateMetricCard('coverage', metrics.code_coverage_percent || 0);
      updateMetricCard('security', metrics.security_score || 0);
      updateMetricCard('performance', metrics.performance_score || 0);
      updateMetricCard('test', metrics.test_pass_rate || 0);

      // Update test details
      const testDetails = document.getElementById('test-details');
      if (testDetails) {
        const passing = metrics.passing_tests || 0;
        const total = metrics.total_tests || 0;
        testDetails.textContent = `${passing} of ${total} tests passing`;
      }

      // Update vulnerabilities
      updateVulnerabilities(metrics);

      // Update technical debt
      updateTechnicalDebt(metrics.technical_debt_hours || 0);

      // Update uptime
      updateUptime(metrics.uptime_percent || 100, metrics.response_time_ms || 0);

      // Update deployments
      updateDeployments(result.metrics.deployments || []);

      // Update code quality grade
      updateCodeGrade(metrics.code_quality_grade || 'C');

    } catch (error) {
      console.error('Error loading code quality metrics:', error);
      if (qualityLoading) qualityLoading.style.display = 'none';
      if (qualityEmpty) qualityEmpty.style.display = 'flex';
    }
  }

  function updateHealthScore(score, trend) {
    const scoreNumber = document.getElementById('health-score-number');
    const progressCircle = document.getElementById('health-progress-circle');
    const statusText = document.querySelector('.health-score-status .status-text');
    const statusDot = document.querySelector('.health-score-status .status-dot');
    const trendElement = document.getElementById('health-trend');

    if (scoreNumber) {
      scoreNumber.textContent = score;
    }

    // Animate circle
    if (progressCircle) {
      const circumference = 2 * Math.PI * 90;
      const offset = circumference - (score / 100) * circumference;
      progressCircle.style.strokeDashoffset = offset;

      // Color based on score
      if (score >= 80) {
        progressCircle.style.stroke = '#10b981';
      } else if (score >= 60) {
        progressCircle.style.stroke = '#f59e0b';
      } else {
        progressCircle.style.stroke = '#ef4444';
      }
    }

    // Update status
    if (statusText) {
      if (score >= 80) {
        statusText.textContent = 'Excellent';
        if (statusDot) statusDot.style.background = '#10b981';
      } else if (score >= 60) {
        statusText.textContent = 'Good';
        if (statusDot) statusDot.style.background = '#f59e0b';
      } else {
        statusText.textContent = 'Needs Improvement';
        if (statusDot) statusDot.style.background = '#ef4444';
      }
    }

    // Update trend
    if (trendElement && trend) {
      const arrow = trend.direction === 'up' ? '' : trend.direction === 'down' ? '' : '';
      trendElement.innerHTML = `${arrow} ${trend.value}% from last week`;
      trendElement.className = `health-trend ${trend.direction}`;
    }
  }

  function updateMetricCard(type, value) {
    const valueElement = document.getElementById(`${type}-value`);
    const barElement = document.getElementById(`${type}-bar`);

    if (valueElement) {
      valueElement.textContent = `${value}%`;
    }

    if (barElement) {
      barElement.style.width = `${value}%`;
    }
  }

  function updateVulnerabilities(metrics) {
    const critical = document.getElementById('vuln-critical');
    const high = document.getElementById('vuln-high');
    const medium = document.getElementById('vuln-medium');
    const low = document.getElementById('vuln-low');

    if (critical) critical.textContent = metrics.vulnerabilities_critical || 0;
    if (high) high.textContent = metrics.vulnerabilities_high || 0;
    if (medium) medium.textContent = metrics.vulnerabilities_medium || 0;
    if (low) low.textContent = metrics.vulnerabilities_low || 0;
  }

  function updateTechnicalDebt(hours) {
    const valueElement = document.getElementById('tech-debt-value');
    const barElement = document.getElementById('tech-debt-bar');

    if (valueElement) {
      valueElement.textContent = `${hours.toFixed(1)} hours`;
    }

    if (barElement) {
      // Cap at 100 hours for visualization
      const percentage = Math.min((hours / 100) * 100, 100);
      barElement.style.width = `${percentage}%`;
    }
  }

  function updateUptime(uptime, responseTime) {
    const uptimeValue = document.getElementById('uptime-value');
    const uptimeStatus = document.getElementById('uptime-status');
    const responseTimeSpan = document.getElementById('response-time');

    if (uptimeValue) {
      uptimeValue.textContent = `${uptime.toFixed(1)}%`;
    }

    if (uptimeStatus) {
      if (uptime >= 99) {
        uptimeStatus.innerHTML = '<span class="status-dot" style="background: #10b981;"></span> Online';
        uptimeStatus.className = 'stat-badge success';
      } else {
        uptimeStatus.innerHTML = '<span class="status-dot" style="background: #f59e0b;"></span> Degraded';
        uptimeStatus.style.color = '#f59e0b';
      }
    }

    if (responseTimeSpan) {
      responseTimeSpan.textContent = `${responseTime}ms`;
    }
  }

  function updateDeployments(deployments) {
    const timeline = document.getElementById('deployments-timeline');
    if (!timeline) return;

    if (deployments.length === 0) {
      timeline.innerHTML = '<p class="empty-message">No deployments yet</p>';
      return;
    }

    timeline.innerHTML = deployments.map(deployment => {
      const statusClass = deployment.status || 'success';
      const statusIcon = statusClass === 'success' ? '' : '';
      const deployedDate = new Date(deployment.deployed_at);
      const formattedDate = deployedDate.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      return `
        <div class="deployment-item ${statusClass}">
          <div class="deployment-status-icon ${statusClass}">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              ${statusClass === 'success'
                ? '<polyline points="20 6 9 17 4 12"/>'
                : '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'}
            </svg>
          </div>
          <div class="deployment-info">
            <div class="deployment-header">
              <span class="deployment-version">${escapeHtml(deployment.version || 'v1.0.0')}</span>
              <span class="deployment-time">${formattedDate}</span>
            </div>
            <div class="deployment-details">
              <span class="deployment-detail">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 11l3 3L22 4"/>
                  <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
                ${escapeHtml(deployment.branch || 'main')}
              </span>
              <span class="deployment-detail">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                ${deployment.duration_seconds || 0}s
              </span>
              <span class="deployment-detail">By ${escapeHtml(deployment.deployed_by || 'admin')}</span>
            </div>
            ${deployment.commit_message ? `<div class="deployment-message">"${escapeHtml(deployment.commit_message)}"</div>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function updateCodeGrade(grade) {
    const gradeDisplay = document.getElementById('grade-display');
    if (!gradeDisplay) return;

    const gradeBadge = gradeDisplay.querySelector('.grade-badge');
    const gradeText = gradeDisplay.querySelector('p');

    if (gradeBadge) {
      gradeBadge.textContent = grade;

      // Update colors based on grade
      const gradeColors = {
        'A+': { bg: 'linear-gradient(135deg, #10b981, #059669)', shadow: 'rgba(16, 185, 129, 0.4)' },
        'A': { bg: 'linear-gradient(135deg, #10b981, #059669)', shadow: 'rgba(16, 185, 129, 0.4)' },
        'B': { bg: 'linear-gradient(135deg, #3b82f6, #2563eb)', shadow: 'rgba(59, 130, 246, 0.4)' },
        'C': { bg: 'linear-gradient(135deg, #f59e0b, #d97706)', shadow: 'rgba(245, 158, 11, 0.4)' },
        'D': { bg: 'linear-gradient(135deg, #ef4444, #dc2626)', shadow: 'rgba(239, 68, 68, 0.4)' },
        'F': { bg: 'linear-gradient(135deg, #7f1d1d, #991b1b)', shadow: 'rgba(127, 29, 29, 0.4)' }
      };

      const colors = gradeColors[grade] || gradeColors['C'];
      gradeBadge.style.background = colors.bg;
      gradeBadge.style.boxShadow = `0 10px 30px ${colors.shadow}`;
    }

    if (gradeText) {
      const gradeMessages = {
        'A+': 'Your code exceeds industry best practices and standards',
        'A': 'Your code meets industry best practices and standards',
        'B': 'Your code is good with minor areas for improvement',
        'C': 'Your code is acceptable but has room for improvement',
        'D': 'Your code needs significant improvement',
        'F': 'Your code requires immediate attention'
      };

      gradeText.textContent = gradeMessages[grade] || gradeMessages['C'];
    }
  }

  // Load project on page load
  loadProjectDetails();
</script>
