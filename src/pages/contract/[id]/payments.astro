---
export const prerender = false;

import BaseLayout from '@/layouts/BaseLayout.astro';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}
---

<BaseLayout title="Contract Payments" description="View and pay for your contract milestones">
  <div class="payments-page">
    <div class="container">
      <div class="payments-header" id="payments-header" style="display: none;">
        <div class="header-content">
          <div class="contract-logo">
            <svg width="40" height="40" viewBox="0 0 100 100" fill="none">
              <rect width="100" height="100" rx="20" fill="url(#logo-gradient)"/>
              <circle cx="50" cy="50" r="30" stroke="white" stroke-width="6" fill="none"/>
              <path d="M50 30 v20 h10" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
              <defs>
                <linearGradient id="logo-gradient" x1="0" y1="0" x2="100" y2="100">
                  <stop offset="0%" stop-color="#6366f1"/>
                  <stop offset="100%" stop-color="#ec4899"/>
                </linearGradient>
              </defs>
            </svg>
          </div>
          <div>
            <h1 id="contract-title">Loading...</h1>
            <p class="subtitle" id="contract-number"></p>
          </div>
        </div>
      </div>

      <div class="loading-state" id="loading-state">
        <div class="spinner"></div>
        <p>Loading payment information...</p>
      </div>

      <div class="error-state" id="error-state" style="display: none;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <h2>Contract Not Found</h2>
        <p>The contract you're looking for doesn't exist or has been removed.</p>
      </div>

      <div class="payments-content" id="payments-content" style="display: none;">
        <!-- Payment Summary -->
        <div class="payment-summary glass">
          <h2>Payment Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Total Contract Value</span>
              <span class="summary-value" id="total-value">--</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Total Paid</span>
              <span class="summary-value success" id="total-paid">--</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Remaining Balance</span>
              <span class="summary-value warning" id="total-remaining">--</span>
            </div>
          </div>
        </div>

        <!-- Milestones List -->
        <div class="milestones-section">
          <h2>Payment Milestones</h2>
          <div class="milestones-container" id="milestones-container">
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Loading milestones...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .payments-page {
      min-height: 100vh;
      padding: 2rem 0 4rem;
      background: var(--gradient-background);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .payments-header {
      margin-bottom: 2rem;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .contract-logo {
      flex-shrink: 0;
    }

    .payments-header h1 {
      font-size: 2rem;
      font-weight: 800;
      color: var(--color-text);
      margin: 0 0 0.25rem;
    }

    .subtitle {
      color: var(--color-text-muted);
      font-size: 0.875rem;
      margin: 0;
    }

    .loading-state,
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      text-align: center;
      color: var(--color-text-muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--glass-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-state svg {
      color: #ef4444;
      margin-bottom: 1rem;
    }

    .error-state h2 {
      font-size: 1.5rem;
      color: var(--color-text);
      margin: 0 0 0.5rem;
    }

    .glass {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      backdrop-filter: blur(20px);
    }

    .payment-summary {
      margin-bottom: 2rem;
    }

    .payment-summary h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
      margin: 0 0 1.5rem;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1.5rem;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
    }

    .summary-label {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      font-weight: 600;
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
    }

    .summary-value.success {
      color: #10b981;
    }

    .summary-value.warning {
      color: #f59e0b;
    }

    .milestones-section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-text);
      margin: 0 0 1.5rem;
    }

    .milestones-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .milestone-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
    }

    .milestone-card:hover {
      box-shadow: 0 10px 40px rgba(99, 102, 241, 0.15);
    }

    .milestone-card.paid {
      border-color: #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
    }

    .milestone-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .milestone-info h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text);
      margin: 0 0 0.25rem;
    }

    .milestone-info p {
      color: var(--color-text-muted);
      font-size: 0.875rem;
      margin: 0;
    }

    .status-badge {
      padding: 0.375rem 0.875rem;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-badge.pending {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
    }

    .status-badge.paid {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .status-badge.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .milestone-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--color-bg);
      border-radius: var(--radius-md);
    }

    .milestone-detail {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .milestone-detail-label {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .milestone-detail-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .milestone-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--color-text-muted);
    }

    .empty-state svg {
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .summary-grid,
      .milestone-details {
        grid-template-columns: 1fr;
      }

      .milestone-header {
        flex-direction: column;
        gap: 1rem;
      }

      .milestone-actions {
        width: 100%;
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>

  <script is:inline define:vars={{ contractId: id }}>
    // Import sanitization utilities
    const sanitizeHTML = (html) => {
      if (!html) return '';
      html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
      html = html.replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi, '');
      html = html.replace(/\s*on\w+\s*=\s*[^\s>]*/gi, '');
      html = html.replace(/javascript:/gi, '');
      html = html.replace(/data:text\/html/gi, '');
      html = html.replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '');
      html = html.replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi, '');
      html = html.replace(/<embed\b[^<]*(?:(?!<\/embed>)<[^<]*)*<\/embed>/gi, '');
      html = html.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '');
      html = html.replace(/\s*style\s*=\s*["'][^"']*expression\([^"']*\)["']/gi, '');
      return html;
    };

    const escapeHTML = (text) => {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    };

    class ContractPayments {
      constructor() {
        this.contractId = contractId;
        this.contract = null;
        this.milestones = [];
        this.init();
      }

      async init() {
        await this.loadContract();
        await this.loadMilestones();
      }

      async loadContract() {
        try {
          const response = await fetch(`/api/contracts/${this.contractId}`);

          if (!response.ok) {
            throw new Error('Contract not found');
          }

          this.contract = await response.json();
          this.renderContractHeader();
        } catch (error) {
          console.error('Error loading contract:', error);
          this.showError();
        }
      }

      async loadMilestones() {
        try {
          const response = await fetch(`/api/contracts/${this.contractId}/milestones`);

          if (!response.ok) {
            throw new Error('Failed to load milestones');
          }

          this.milestones = await response.json();
          this.renderMilestones();
          this.updateSummary();

          // Hide loading, show content
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('payments-content').style.display = 'block';
          document.getElementById('payments-header').style.display = 'block';
        } catch (error) {
          console.error('Error loading milestones:', error);
          this.showError();
        }
      }

      renderContractHeader() {
        document.getElementById('contract-title').textContent = this.contract.title;
        document.getElementById('contract-number').textContent =
          `${this.contract.contract_number} â€¢ ${this.contract.client_name}`;
      }

      renderMilestones() {
        const container = document.getElementById('milestones-container');

        if (this.milestones.length === 0) {
          // Static HTML - safe (no user content)
          container.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
              </svg>
              <p>No payment milestones have been set up for this contract yet.</p>
            </div>
          `;
          return;
        }

        // Sanitize milestone data before rendering
        container.innerHTML = this.milestones.map(milestone => sanitizeHTML(this.milestoneCardHTML(milestone))).join('');

        // Attach event listeners
        this.milestones.forEach(milestone => {
          if (milestone.status === 'pending') {
            document.getElementById(`pay-${milestone.id}`)?.addEventListener('click', () => {
              this.initializePayment(milestone.id);
            });
          }
        });
      }

      milestoneCardHTML(milestone) {
        const dueDate = milestone.due_date ? new Date(milestone.due_date).toLocaleDateString() : 'No due date';
        const paidDate = milestone.paid_at ? new Date(milestone.paid_at).toLocaleDateString() : null;
        const currency = this.contract.currency || 'GHS';

        // Escape user-provided data to prevent XSS
        const safeTitle = escapeHTML(milestone.title);
        const safeDescription = milestone.description ? escapeHTML(milestone.description) : '';
        const safeStatus = escapeHTML(milestone.status);

        return `
          <div class="milestone-card ${safeStatus}">
            <div class="milestone-header">
              <div class="milestone-info">
                <h3>${safeTitle}</h3>
                ${safeDescription ? `<p>${safeDescription}</p>` : ''}
              </div>
              <span class="status-badge ${safeStatus}">${safeStatus}</span>
            </div>

            <div class="milestone-details">
              <div class="milestone-detail">
                <span class="milestone-detail-label">Amount</span>
                <span class="milestone-detail-value">${currency} ${parseFloat(milestone.amount).toFixed(2)}</span>
              </div>
              ${milestone.percentage ? `
              <div class="milestone-detail">
                <span class="milestone-detail-label">Percentage</span>
                <span class="milestone-detail-value">${milestone.percentage}%</span>
              </div>
              ` : ''}
              <div class="milestone-detail">
                <span class="milestone-detail-label">${milestone.status === 'paid' ? 'Paid On' : 'Due Date'}</span>
                <span class="milestone-detail-value">${milestone.status === 'paid' ? paidDate : dueDate}</span>
              </div>
            </div>

            ${milestone.status === 'pending' ? `
            <div class="milestone-actions">
              <button class="btn btn-primary" id="pay-${milestone.id}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                Pay Now
              </button>
            </div>
            ` : milestone.status === 'paid' ? `
            <div class="milestone-actions">
              <button class="btn btn-secondary" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Payment Completed
              </button>
            </div>
            ` : ''}
          </div>
        `;
      }

      updateSummary() {
        const total = this.contract.total_amount || 0;
        const paid = this.milestones
          .filter(m => m.status === 'paid')
          .reduce((sum, m) => sum + parseFloat(m.amount), 0);
        const remaining = this.milestones
          .filter(m => m.status === 'pending')
          .reduce((sum, m) => sum + parseFloat(m.amount), 0);

        const currency = this.contract.currency || 'GHS';
        document.getElementById('total-value').textContent = `${currency} ${total.toFixed(2)}`;
        document.getElementById('total-paid').textContent = `${currency} ${paid.toFixed(2)}`;
        document.getElementById('total-remaining').textContent = `${currency} ${remaining.toFixed(2)}`;
      }

      async initializePayment(milestoneId) {
        const btn = document.getElementById(`pay-${milestoneId}`);
        if (!btn) return;

        btn.disabled = true;
        btn.textContent = 'Initializing payment...';

        try {
          const response = await fetch('/api/payments/initialize', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              milestone_id: milestoneId
            })
          });

          if (!response.ok) {
            throw new Error('Failed to initialize payment');
          }

          const data = await response.json();

          // Redirect to Paystack
          window.location.href = data.authorization_url;
        } catch (error) {
          console.error('Error initializing payment:', error);
          alert('Failed to initialize payment. Please try again.');
          btn.disabled = false;
          // Static HTML - safe (no user content)
          btn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Pay Now
          `;
        }
      }

      showError() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'flex';
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new ContractPayments());
    } else {
      new ContractPayments();
    }
  </script>
</BaseLayout>
